package org.openmrs.module.arielreports.reporting.library.queries;

/** Created by Hamilton Mutaquiha */
public class ReportQueries {

  /** Mulheres Grávidas a mais de 9 meses sem data de parto */
  public static final String GRAVIDAS =
      "select * \n"
          + "from \n"
          + "(	select 	inicio.patient_id,\n"
          + "	inicio.data_inicio,\n"
          + "	ultimo.ultimo_levantamento ultimo_lev,\n"
          + "	ultimo.value_datetime proximo_lev,\n"
          + "	saida_real.encounter_datetime data_saida,\n"
          + "	pid.identifier nid,\n"
          + "	pad3.address6 localidade,\n"
          + "	pad3.address5 bairro,\n"
          + "	pad3.address3 celula,\n"
          + "	pad3.address1 ponto_referencia,\n"
          + "	pat.value as telefone,\n"
          + "	confidente.telefone as telefone_confidente,\n"
          + "	inscricao.telefone as telefone_referencia,\n"
          + "	if(saida_real.estado is not null,saida_real.estado,if(ultimo.value_datetime is not null,if(datediff(:endDate,ultimo.value_datetime)>60,'ABANDONO NAO NOTIFICADO','ACTIVO'),'SEM DATA PROXIMA NO ULTIMO LEVANTAMENTO' )) estado,\n"
          + "	concat(ifnull(pn.given_name,''),' ',ifnull(pn.middle_name,''),' ',ifnull(pn.family_name,'')) as nome_completo,\n"
          + "	pr.gender as genero,\n"
          + "	round(datediff(current_date,pr.birthdate)/365) idade_actual,\n"
          + "	if(gravida.patient_id is not null,'SIM','') gravida,\n"
          + "	proveniencia.referencia as proveniencia\n"
          + "	from		\n"
          + "	(	select patient_id,data_inicio\n"
          + "		from\n"
          + "		(	Select patient_id,min(data_inicio) data_inicio\n"
          + "			from\n"
          + "			(	Select 	p.patient_id,min(e.encounter_datetime) data_inicio\n"
          + "				from patient p \n"
          + "				inner join encounter e on p.patient_id=e.patient_id	\n"
          + "				inner join obs o on o.encounter_id=e.encounter_id\n"
          + "				where e.voided=0 and o.voided=0 and p.voided=0 \n"
          + "				and e.encounter_type in (18,6,9) \n"
          + "				and o.concept_id=1255 \n"
          + "				and o.value_coded=1256 \n"
          + "				and e.encounter_datetime<=:endDate \n"
          + "				and e.location_id=:location\n"
          + "				group by p.patient_id\n"
          + "		\n"
          + "				union\n"
          + "		\n"
          + "				Select p.patient_id,min(value_datetime) data_inicio\n"
          + "				from patient p\n"
          + "				inner join encounter e on p.patient_id=e.patient_id\n"
          + "				inner join obs o on e.encounter_id=o.encounter_id\n"
          + "				where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "				and e.encounter_type in (18,6,9) \n"
          + "				and o.concept_id=1190 \n"
          + "				and o.value_datetime is not null \n"
          + "				and o.value_datetime<=:endDate \n"
          + "				and e.location_id=:location\n"
          + "				group by p.patient_id\n"
          + "\n"
          + "				union\n"
          + "\n"
          + "				select pg.patient_id,date_enrolled data_inicio\n"
          + "				from patient p inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "				where pg.voided=0 and p.voided=0 \n"
          + "				and program_id=2 \n"
          + "				and date_enrolled<=:endDate \n"
          + "				and location_id=:location\n"
          + "				\n"
          + "				union\n"
          + "				\n"
          + "				\n"
          + "				SELECT e.patient_id, MIN(e.encounter_datetime) AS data_inicio \n"
          + "				FROM patient p\n"
          + "				inner join encounter e on p.patient_id=e.patient_id\n"
          + "				WHERE p.voided=0 AND e.voided=0 \n"
          + "				and e.encounter_type=18 \n"
          + "				and e.encounter_datetime<=:endDate \n"
          + "				and e.location_id=:location\n"
          + "				GROUP BY 	p.patient_id\n"
          + "			) inicio0\n"
          + "			group by patient_id	\n"
          + "		)inicio1\n"
          + "	)inicio\n"
          + "	inner join\n"
          + "	(\n"
          + "		select p.patient_id,o1.value_text as telefone\n"
          + "		from patient p \n"
          + "		inner join encounter e on e.patient_id=p.patient_id\n"
          + "		left join obs o1 on o1.encounter_id=e.encounter_id and o1.concept_id=1611\n"
          + "		where e.voided=0 and p.voided=0 \n"
          + "		and e.encounter_type in (5,7) \n"
          + "		and e.encounter_datetime<=:endDate \n"
          + "		and e.location_id = :location\n"
          + "\n"
          + "		union\n"
          + "\n"
          + "		select pg.patient_id, null as telefone\n"
          + "		from patient p inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "		where pg.voided=0 and p.voided=0 \n"
          + "		and program_id=1 \n"
          + "		and date_enrolled<=:endDate \n"
          + "		and location_id=:location\n"
          + "	)inscricao on inicio.patient_id=inscricao.patient_id\n"
          + "	left join\n"
          + "	(	select max_frida.patient_id,max_frida.ultimo_levantamento,o.value_datetime\n"
          + "		from\n"
          + "		(	Select p.patient_id,max(encounter_datetime) ultimo_levantamento\n"
          + "			from patient p \n"
          + "			inner join encounter e on e.patient_id=p.patient_id\n"
          + "			where p.voided=0 and e.voided=0 \n"
          + "			and e.encounter_type=18 \n"
          + "			and e.location_id=:location \n"
          + "			and e.encounter_datetime<=:endDate\n"
          + "			group by p.patient_id\n"
          + "		) max_frida \n"
          + "		left join obs o on o.person_id=max_frida.patient_id and max_frida.ultimo_levantamento=o.obs_datetime and o.voided=0 and o.concept_id=5096		\n"
          + "	) ultimo on inicio.patient_id=ultimo.patient_id\n"
          + "	left join	\n"
          + "	(	select 	pg.patient_id,ps.start_date encounter_datetime,location_id,\n"
          + "		case ps.state\n"
          + "		when 7 then 'TRANSFERIDO PARA'\n"
          + "		when 8 then 'SUSPENSO'\n"
          + "		when 9 then 'ABANDONO'\n"
          + "		when 10 then 'OBITO'\n"
          + "		else 'OUTRO' end as estado\n"
          + "		from patient p \n"
          + "		inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "		inner join patient_state ps on pg.patient_program_id=ps.patient_program_id\n"
          + "		where pg.voided=0 and ps.voided=0 and p.voided=0 \n"
          + "		and ps.start_date<=:endDate \n"
          + "		and pg.program_id=2 \n"
          + "		and ps.state in (7,8,9,10) \n"
          + "		and ps.end_date is null \n"
          + "		and location_id=:location\n"
          + "	) saida_real on inicio.patient_id=saida_real.patient_id	\n"
          + "	inner join \n"
          + "	(\n"
          + "		Select p.patient_id\n"
          + "		from patient p \n"
          + "		inner join encounter e on p.patient_id=e.patient_id\n"
          + "		inner join obs o on e.encounter_id=o.encounter_id\n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "		and concept_id=1982 \n"
          + "		and value_coded=44 \n"
          + "		and e.encounter_type in (5,6) \n"
          + "		and e.encounter_datetime <= date_add(:endDate, interval -9 month)\n"
          + "		and e.location_id=:location\n"
          + "\n"
          + "		union		\n"
          + "				\n"
          + "		Select p.patient_id\n"
          + "		from patient p inner join encounter e on p.patient_id=e.patient_id\n"
          + "		inner join obs o on e.encounter_id=o.encounter_id\n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "		and concept_id=1279 \n"
          + "		and e.encounter_type in (5,6) \n"
          + "		and e.encounter_datetime < date_add(:endDate, interval -9 month) \n"
          + "		and e.location_id=:location\n"
          + "\n"
          + "		union		\n"
          + "				\n"
          + "		Select p.patient_id\n"
          + "		from patient p inner join encounter e on p.patient_id=e.patient_id\n"
          + "		inner join obs o on e.encounter_id=o.encounter_id\n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "		and concept_id=1600 \n"
          + "		and e.encounter_type in (5,6) \n"
          + "		and e.encounter_datetime < date_add(:endDate, interval -9 month) \n"
          + "		and e.location_id=:location		\n"
          + "				\n"
          + "		union\n"
          + "				\n"
          + "		select pp.patient_id\n"
          + "		from patient_program pp \n"
          + "		where pp.program_id=8 and pp.voided=0 \n"
          + "		and pp.date_enrolled < date_add(:endDate, interval -9 month) \n"
          + "		and pp.location_id=:location\n"
          + "	\n"
          + "	) gravida on gravida.patient_id= inicio.patient_id\n"
          + "	left join\n"
          + "	(\n"
          + "		select p.patient_id, pr.name referencia, max(pp.date_enrolled) as data_inicio_programa\n"
          + "		from patient p\n"
          + "		inner join patient_program pp on pp.patient_id=p.patient_id\n"
          + "		inner join program pr on pr.program_id=pp.program_id\n"
          + "		where pp.date_enrolled < :endDate\n"
          + "		and pp.date_completed is null\n"
          + "		and pp.location_id=:location\n"
          + "		and p.voided=0 and pp.voided=0\n"
          + "		group by patient_id,pr.name\n"
          + "	) proveniencia on proveniencia.patient_id=inicio.patient_id\n"
          + "	left join \n"
          + "	(	select pad1.*\n"
          + "		from person_address pad1\n"
          + "		inner join \n"
          + "		(\n"
          + "			select person_id,min(person_address_id) id \n"
          + "			from person_address\n"
          + "			where voided=0\n"
          + "			group by person_id\n"
          + "		) pad2\n"
          + "		where pad1.person_id=pad2.person_id and pad1.person_address_id=pad2.id\n"
          + "	) pad3 on pad3.person_id=inicio.patient_id				\n"
          + "	left join 			\n"
          + "	(	select pn1.*\n"
          + "		from person_name pn1\n"
          + "		inner join \n"
          + "		(\n"
          + "			select person_id,min(person_name_id) id \n"
          + "			from person_name\n"
          + "			where voided=0\n"
          + "			group by person_id\n"
          + "		) pn2\n"
          + "		where pn1.person_id=pn2.person_id and pn1.person_name_id=pn2.id\n"
          + "	) pn on pn.person_id=inicio.patient_id			\n"
          + "	left join\n"
          + "	(   select pid1.*\n"
          + "		from patient_identifier pid1\n"
          + "		inner join\n"
          + "		(\n"
          + "			select patient_id,min(patient_identifier_id) id\n"
          + "			from patient_identifier\n"
          + "			where voided=0\n"
          + "			group by patient_id\n"
          + "		) pid2\n"
          + "		where pid1.patient_id=pid2.patient_id and pid1.patient_identifier_id=pid2.id\n"
          + "	) pid on pid.patient_id=inicio.patient_id	\n"
          + "	left join person pr on pr.person_id=inicio.patient_id\n"
          + "	left join person_attribute pat on pat.person_id=inicio.patient_id and pat.person_attribute_type_id=9 and pat.value is not null and pat.value<>'' and pat.voided=0\n"
          + "	left join\n"
          + "	(\n"
          + "		select p.patient_id, o.value_text as telefone\n"
          + "		from patient p\n"
          + "		inner join encounter e on e.patient_id=p.patient_id\n"
          + "		inner join obs o on o.encounter_id=e.encounter_id \n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0\n"
          + "		and e.encounter_type=34\n"
          + "		and o.concept_id=1611\n"
          + "		and e.location_id=:location\n"
          + "	) confidente on inicio.patient_id=confidente.patient_id\n"
          + ") coortes\n"
          + "group by patient_id";

  /** Pacientes com CV < 0 */
  public static final String PACIENTES_CV_NEGATIVA =
      "Select p.patient_id,\n"
          + "	pid.identifier as nid, \n"
          + "	concat(ifnull(pn.given_name,''),' ',ifnull(pn.middle_name,''),' ',ifnull(pn.family_name,'')) as nome_completo,\n"
          + "	o.value_numeric valor_cv,\n"
          + "	o.obs_datetime data_cv\n"
          + "from patient p\n"
          + "inner join encounter e on p.patient_id=e.patient_id\n"
          + "inner join obs o on e.encounter_id=o.encounter_id				\n"
          + "left join 			\n"
          + "(	select pn1.*\n"
          + "	from person_name pn1\n"
          + "	inner join \n"
          + "	(\n"
          + "		select person_id,min(person_name_id) id \n"
          + "		from person_name\n"
          + "		where voided=0\n"
          + "		group by person_id\n"
          + "	) pn2\n"
          + "	where pn1.person_id=pn2.person_id and pn1.person_name_id=pn2.id\n"
          + ") pn on pn.person_id=p.patient_id			\n"
          + "left join\n"
          + "(   select pid1.*\n"
          + "	from patient_identifier pid1\n"
          + "	inner join\n"
          + "	(\n"
          + "		select patient_id,min(patient_identifier_id) id\n"
          + "		from patient_identifier\n"
          + "		where voided=0\n"
          + "		group by patient_id\n"
          + "	) pid2\n"
          + "	where pid1.patient_id=pid2.patient_id and pid1.patient_identifier_id=pid2.id\n"
          + ") pid on pid.patient_id=p.patient_id\n"
          + "where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "and e.encounter_type in (13,6,9) \n"
          + "and o.concept_id=856 \n"
          + "and o.value_numeric is not null\n"
          + "and o.value_numeric < 0\n"
          + "and e.encounter_datetime < :endDate \n"
          + "and e.location_id=:location";

  /** Pacientes Inscritos no Serviço TARV */
  public static final String INSCRITOS_SERVICO_TARV =
      "select *\n"
          + "from\n"
          + "(	select 	inscricao.patient_id,\n"
          + "	inscricao.data_abertura,\n"
          + "	inscricao.gender as genero,\n"
          + "	inscricao.dead,\n"
          + "	inscricao.death_date,\n"
          + "	inscricao.idade_abertura,\n"
          + "	inscricao.idade_actual,\n"
          + "	pad3.county_district as 'Distrito',\n"
          + "	pad3.address2 as 'PAdministrativo',\n"
          + "	pad3.address6 as localidade,\n"
          + "	pad3.address5 as bairro,\n"
          + "	pad3.address1 as ponto_referencia,\n"
          + "	concat(ifnull(pn.given_name,''),' ',ifnull(pn.middle_name,''),' ',ifnull(pn.family_name,'')) as nome_completo,			\n"
          + "	pid.identifier as nid,\n"
          + "	transferido.data_transferido_de,\n"
          + "	if(transferido.program_id is null,null,if(transferido.program_id=1,'PRE-TARV','TARV')) as transferido_de,\n"
          + "	inicio_real.data_inicio,\n"
          + "	cd4.data_primeiro_cd4,\n"
          + "	cd4.value_numeric,\n"
          + "	estadio.data_estadio,\n"
          + "	estadio.valor_estadio,\n"
          + "	seguimento.data_seguimento,\n"
          + "	if(inscrito_cuidado.date_enrolled is null,'NAO','SIM') inscrito_programa,\n"
          + "	inscrito_cuidado.date_enrolled data_inscricao_programa,\n"
          + "	proveniencia.referencia,\n"
          + "	pat.value as telefone,\n"
          + "	confidente.telefone as telefone_confidente,\n"
          + "	inscricao.telefone as telefone_referencia,\n"
          + "	contacto.data_aceita,\n"
          + "	data_diagnostico	\n"
          + "	from		\n"
          + "	(\n"
          + "		select patient_id,\n"
          + "			data_abertura,\n"
          + "			gender,\n"
          + "			dead,\n"
          + "			death_date,\n"
          + "			min(idade_abertura) idade_abertura,\n"
          + "			idade_actual,\n"
          + "			location_id,\n"
          + "			data_diagnostico,\n"
          + "			telefone\n"
          + "		from(\n"
          + "			Select 	e.patient_id,\n"
          + "			min(encounter_datetime) data_abertura,\n"
          + "			gender,\n"
          + "			dead,\n"
          + "			death_date,\n"
          + "			round(datediff(e.encounter_datetime,pe.birthdate)/365) idade_abertura,\n"
          + "			round(datediff(:endDate,pe.birthdate)/365) idade_actual,\n"
          + "			e.location_id,\n"
          + "			o.value_datetime as data_diagnostico,\n"
          + "			o1.value_text as telefone\n"
          + "			from patient p			\n"
          + "			inner join encounter e on e.patient_id=p.patient_id\n"
          + "			inner join person pe on pe.person_id=p.patient_id	\n"
          + "			inner join obs o on e.encounter_id=o.encounter_id\n"
          + "			left join obs o1 on o1.encounter_id=e.encounter_id and o1.concept_id=1611		\n"
          + "			where p.voided=0 and e.encounter_type in (5,7) \n"
          + "			and e.voided=0 and pe.voided=0 and o.voided=0\n"
          + "			and o.concept_id=6123\n"
          + "			and e.encounter_datetime < :endDate \n"
          + "			and e.location_id=:location\n"
          + "			group by p.patient_id\n"
          + "		\n"
          + "			union all\n"
          + "	\n"
          + "			Select 	e.patient_id,\n"
          + "			o.value_datetime data_abertura,\n"
          + "			gender,\n"
          + "			dead,\n"
          + "			death_date,\n"
          + "			round(datediff(o.value_datetime,pe.birthdate)/365) idade_abertura,\n"
          + "			round(datediff(:endDate,pe.birthdate)/365) idade_actual,\n"
          + "			e.location_id,\n"
          + "			o1.obs_datetime as data_diagnostico,\n"
          + "			o2.value_text as telefone\n"
          + "			from encounter e\n"
          + "			inner join person pe on pe.person_id=e.patient_id	\n"
          + "			inner join obs o on e.encounter_id=o.encounter_id\n"
          + "			left join obs o1 on e.encounter_id=o1.encounter_id and o1.concept_id=22772\n"
          + "			left join obs o2 on o2.encounter_id=e.encounter_id and o2.concept_id=6224\n"
          + "			where e.encounter_type = 53 \n"
          + "			and e.voided=0 and pe.voided=0 and o.voided=0\n"
          + "			and o.concept_id=23891\n"
          + "			and e.encounter_datetime < :endDate \n"
          + "			and e.location_id=:location\n"
          + "		) insc\n"
          + "		group by patient_id\n"
          + "	) inscricao\n"
          + "	left join \n"
          + "	(	select pad1.*\n"
          + "		from person_address pad1\n"
          + "		inner join \n"
          + "		(\n"
          + "			select person_id,min(person_address_id) id \n"
          + "			from person_address\n"
          + "			where voided=0\n"
          + "			group by person_id\n"
          + "		) pad2\n"
          + "		where pad1.person_id=pad2.person_id and pad1.person_address_id=pad2.id\n"
          + "	) pad3 on pad3.person_id=inscricao.patient_id				\n"
          + "	left join 			\n"
          + "	(	select pn1.*\n"
          + "		from person_name pn1\n"
          + "		inner join \n"
          + "		(\n"
          + "			select person_id,min(person_name_id) id \n"
          + "			from person_name\n"
          + "			where voided=0\n"
          + "			group by person_id\n"
          + "		) pn2\n"
          + "		where pn1.person_id=pn2.person_id and pn1.person_name_id=pn2.id\n"
          + "	) pn on pn.person_id=inscricao.patient_id			\n"
          + "	left join\n"
          + "	(  	select pid1.*\n"
          + "		from patient_identifier pid1\n"
          + "		inner join\n"
          + "		(\n"
          + "			select patient_id,min(patient_identifier_id) id\n"
          + "			from patient_identifier\n"
          + "			where voided=0\n"
          + "			group by patient_id\n"
          + "		) pid2\n"
          + "		where pid1.patient_id=pid2.patient_id and pid1.patient_identifier_id=pid2.id\n"
          + "	) pid on pid.patient_id=inscricao.patient_id\n"
          + "	left join \n"
          + "	(	\n"
          + "		select pg.patient_id,max(ps.start_date) data_transferido_de,pg.program_id\n"
          + "		from patient p \n"
          + "		inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "		inner join patient_state ps on pg.patient_program_id=ps.patient_program_id\n"
          + "		where pg.voided=0 and ps.voided=0 and p.voided=0 and \n"
          + "		pg.program_id in (1,2) and ps.state in (28,29) and \n"
          + "		ps.start_date between :startDate and :endDate and location_id=:location	\n"
          + "		group by pg.patient_id\n"
          + "\n"
          + "		union	\n"
          + "		\n"
          + "		Select p.patient_id,o.obs_datetime data_transferido_de,\n"
          + "		case o1.value_coded\n"
          + "		when 6275 then 1\n"
          + "		when 6276 then 2 end as program_id\n"
          + "		from patient p\n"
          + "		inner join encounter e on p.patient_id=e.patient_id\n"
          + "		inner join obs o on e.encounter_id=o.encounter_id\n"
          + "		inner join obs o1 on e.encounter_id=o1.encounter_id\n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0 and o1.voided=0 \n"
          + "		and e.encounter_type=53 \n"
          + "		and o.concept_id=1369\n"
          + "		and o.value_coded=1065\n"
          + "		and o1.concept_id=6300\n"
          + "		and e.encounter_datetime between :startDate and :endDate \n"
          + "		and o.location_id=:location\n"
          + "	) transferido on transferido.patient_id=inscricao.patient_id and transferido.data_transferido_de<=inscricao.data_abertura\n"
          + "	left join 		\n"
          + "	(	Select patient_id,min(data_inicio) data_inicio\n"
          + "		from\n"
          + "		(	Select 	p.patient_id, min(e.encounter_datetime) data_inicio\n"
          + "			from patient p \n"
          + "			inner join encounter e on p.patient_id=e.patient_id	\n"
          + "			inner join obs o on o.encounter_id=e.encounter_id\n"
          + "			where e.voided=0 and o.voided=0 and p.voided=0 \n"
          + "			and e.encounter_type in (18,6,9) \n"
          + "			and o.concept_id=1255 \n"
          + "			and o.value_coded=1256 \n"
          + "			and e.encounter_datetime between :startDate and :endDate \n"
          + "			and e.location_id=:location\n"
          + "			group by p.patient_id\n"
          + "\n"
          + "			union	\n"
          + "			\n"
          + "			Select p.patient_id, min(value_datetime) data_inicio\n"
          + "			from patient p\n"
          + "			inner join encounter e on p.patient_id=e.patient_id\n"
          + "			inner join obs o on e.encounter_id=o.encounter_id\n"
          + "			where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "			and e.encounter_type in (18,6,9,53) \n"
          + "			and o.concept_id=1190 \n"
          + "			and o.value_datetime is not null \n"
          + "			and o.value_datetime between :startDate and :endDate \n"
          + "			and o.location_id=:location\n"
          + "			group by p.patient_id\n"
          + "		) inicio\n"
          + "		group by patient_id\n"
          + "	) inicio_real on inscricao.patient_id=inicio_real.patient_id		\n"
          + "	left join \n"
          + "	(	select patient_id,min(data_primeiro_cd4) data_primeiro_cd4,max(value_numeric) value_numeric\n"
          + "		from	\n"
          + "		(	select e.patient_id,\n"
          + "			min(o.obs_datetime) data_primeiro_cd4\n"
          + "			from encounter e\n"
          + "			inner join obs o on e.encounter_id=o.encounter_id\n"
          + "			where e.encounter_type in (13,6,9,53) \n"
          + "			and e.voided=0 and o.voided=0 \n"
          + "			and o.concept_id in (5497,1695) \n"
          + "			and e.encounter_datetime between :startDate and :endDate \n"
          + "			and e.location_id=:location\n"
          + "			group by e.patient_id\n"
          + "		) primeiro_cd4\n"
          + "		inner join obs o on o.person_id=primeiro_cd4.patient_id and o.obs_datetime=primeiro_cd4.data_primeiro_cd4\n"
          + "		where o.concept_id in (5497,1695) \n"
          + "		and o.voided=0\n"
          + "		group by patient_id\n"
          + "	) cd4 on cd4.patient_id=inscricao.patient_id\n"
          + "	left join\n"
          + "	(	select o.person_id patient_id,o.obs_datetime data_estadio,\n"
          + "		case o.value_coded\n"
          + "		when 1204 then 'I'\n"
          + "		when 1205 then 'II'\n"
          + "		when 1206 then 'III'\n"
          + "		when 1207 then 'IV'\n"
          + "		else 'OUTRO' end as valor_estadio\n"
          + "		from obs o,				\n"
          + "		(	select p.patient_id,min(encounter_datetime) as encounter_datetime\n"
          + "			from patient p\n"
          + "			inner join encounter e on p.patient_id=e.patient_id\n"
          + "			inner join obs o on o.encounter_id=e.encounter_id\n"
          + "			where encounter_type in (6,9) \n"
          + "			and e.voided=0 and p.voided=0 and o.voided=0\n"
          + "			and encounter_datetime between :startDate and :endDate \n"
          + "			and e.location_id=:location\n"
          + "			and o.concept_id=5356\n"
          + "			group by patient_id\n"
          + "		) d\n"
          + "		where o.person_id=d.patient_id \n"
          + "		and o.obs_datetime=d.encounter_datetime \n"
          + "		and o.voided=0 \n"
          + "		and o.concept_id=5356 \n"
          + "		and o.location_id=:location \n"
          + "		and o.value_coded in (1204,1205,1206,1207)\n"
          + "		group by d.patient_id\n"
          + "	) estadio on estadio.patient_id=inscricao.patient_id\n"
          + "	left join \n"
          + "	(	select patient_id,min(encounter_datetime) data_seguimento\n"
          + "		from encounter\n"
          + "		where voided=0 \n"
          + "		and encounter_type in (6,9) \n"
          + "		and encounter_datetime between :startDate and :endDate\n"
          + "		group by patient_id\n"
          + "	) seguimento on seguimento.patient_id=inscricao.patient_id\n"
          + "	left join\n"
          + "	(\n"
          + "		select pg.patient_id,date_enrolled\n"
          + "		from patient p inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "		where pg.voided=0 and p.voided=0 \n"
          + "		and program_id=1 \n"
          + "		and date_enrolled between :startDate and :endDate \n"
          + "		and location_id=:location\n"
          + "	) inscrito_cuidado on inscrito_cuidado.patient_id=inscricao.patient_id		\n"
          + "	left join\n"
          + "	(	select 	p.patient_id,\n"
          + "		case o.value_coded\n"
          + "		when 1595 then 'INTERNAMENTO'\n"
          + "		when 1596 then 'CONSULTA EXTERNA'\n"
          + "		when 1414 then 'PNCT'\n"
          + "		when 1597 then 'ATS'\n"
          + "		when 1987 then 'SAAJ'\n"
          + "		when 1598 then 'PTV'\n"
          + "		when 1872 then 'CCR'\n"
          + "		when 1275 then 'CENTRO DE SAUDE'\n"
          + "		when 1984 then 'HR'\n"
          + "		when 1599 then 'PROVEDOR PRIVADO'\n"
          + "		when 1932 then 'PROFISSIONAL DE SAUDE'\n"
          + "		when 1387 then 'LABORATÓRIO'\n"
          + "		when 1386 then 'CLINICA MOVEL'\n"
          + "		when 6245 then 'ATSC'\n"
          + "		when 1699 then 'CUIDADOS DOMICILIARIOS'\n"
          + "		when 2160 then 'VISITA DE BUSCA'\n"
          + "		when 6288 then 'SMI'\n"
          + "		when 5484 then 'APOIO NUTRICIONAL'\n"
          + "		when 6155 then 'MEDICO TRADICIONAL'\n"
          + "		when 1044 then 'PEDIATRIA'\n"
          + "		when 6303 then 'VGB'\n"
          + "		when 6304 then 'ATIP'\n"
          + "		when 6305 then 'OBC'\n"
          + "		else 'OUTRO' end as referencia\n"
          + "		from patient p\n"
          + "		inner join encounter e on p.patient_id=e.patient_id\n"
          + "		inner join obs o on o.encounter_id=e.encounter_id\n"
          + "		where encounter_type in (5,7) \n"
          + "		and e.voided=0 and p.voided=0 and o.voided=0  \n"
          + "		and encounter_datetime between :startDate and :endDate \n"
          + "		and e.location_id=:location\n"
          + "		and o.concept_id=1594\n"
          + "\n"
          + "		union	\n"
          + "		\n"
          + "		Select p.patient_id,\n"
          + "		case o.value_coded\n"
          + "		when 1414 then 'PNCT'\n"
          + "		when 1987 then 'SAAJ'\n"
          + "		when 1985 then 'CPN/G'\n"
          + "		when 1872 then 'CCR/L'\n"
          + "		when 21275 then 'CLÍNICA'\n"
          + "		else 'OUTRO' end as referencia\n"
          + "		from patient p\n"
          + "		inner join encounter e on p.patient_id=e.patient_id\n"
          + "		inner join obs o on e.encounter_id=o.encounter_id\n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "		and e.encounter_type=53 \n"
          + "		and o.concept_id=23783\n"
          + "		and e.encounter_datetime between :startDate and :endDate \n"
          + "		and o.location_id=:location			\n"
          + "	) proveniencia on proveniencia.patient_id=inscricao.patient_id\n"
          + "	left join person_attribute pat on pat.person_id=inscricao.patient_id and pat.person_attribute_type_id=9 and pat.value is not null and pat.value<>'' and pat.voided=0\n"
          + "	left join\n"
          + "	(	select p.patient_id,min(encounter_datetime) as data_aceita\n"
          + "		from patient p\n"
          + "		inner join encounter e on p.patient_id=e.patient_id\n"
          + "		inner join obs o on o.encounter_id=e.encounter_id\n"
          + "		where encounter_type in (34,35) \n"
          + "		and e.voided=0 and p.voided=0 and o.voided=0 \n"
          + "		and encounter_datetime<=:endDate \n"
          + "		and e.location_id=:location\n"
          + "		and o.concept_id=6309 \n"
          + "		and o.value_coded=6307\n"
          + "		group by patient_id\n"
          + "	) contacto on contacto.patient_id=inscricao.patient_id\n"
          + "	left join\n"
          + "	(\n"
          + "		select p.patient_id, o.value_text as telefone\n"
          + "		from patient p\n"
          + "		inner join encounter e on e.patient_id=p.patient_id\n"
          + "		inner join obs o on o.encounter_id=e.encounter_id \n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0\n"
          + "		and e.encounter_type=34\n"
          + "		and o.concept_id=1611\n"
          + "		and e.location_id=:location\n"
          + "	) confidente on inscricao.patient_id=confidente.patient_id\n"
          + ")inscritos\n"
          + "where data_abertura > :startDate\n"
          + "group by patient_id";

  /** Pacientes na Coorte TARV */
  public static final String PACIENTES_COORTE_TARV =
      "select * \n"
          + "from \n"
          + "(	select 	inicio.patient_id,\n"
          + "	inicio.data_inicio,\n"
          + "	seguimento.ultimo_seguimento,\n"
          + "	ultimo.ultimo_levantamento ultimo_lev,\n"
          + "	ultimo.value_datetime proximo_lev,\n"
          + "	saida_real.encounter_datetime data_saida,\n"
          + "	pid.identifier nid,\n"
          + "	pad3.address6 localidade,\n"
          + "	pad3.address5 bairro,\n"
          + "	pad3.address3 celula,\n"
          + "	pad3.address1 ponto_referencia,\n"
          + "	pat.value as telefone,\n"
          + "	confidente.telefone as telefone_confidente,\n"
          + "	inscricao.telefone as telefone_referencia,\n"
          + "	if(saida_real.estado is not null,saida_real.estado,if(ultimo.value_datetime is not null,if(datediff(:dateCoorte,ultimo.value_datetime)>60,'ABANDONO NAO NOTIFICADO','ACTIVO'),'SEM DATA PROXIMA NO ULTIMO LEVANTAMENTO' )) estado,\n"
          + "	concat(ifnull(pn.given_name,''),' ',ifnull(pn.middle_name,''),' ',ifnull(pn.family_name,'')) as nome_completo,\n"
          + "	pr.gender as genero,\n"
          + "	round(datediff(current_date,pr.birthdate)/365) idade_actual,\n"
          + "	if(gravida.patient_id is not null,'SIM','') gravida,\n"
          + "	proveniencia.referencia as proveniencia,\n"
          + "	ultimo.ultimo_regime as regime,\n"
          + "	recepcao_levantamento.ultimo_levantamento as ultimo_rec_lev\n"
          + "	from		\n"
          + "	(	select patient_id,data_inicio\n"
          + "		from\n"
          + "		(	Select patient_id,min(data_inicio) data_inicio\n"
          + "			from\n"
          + "			(	Select 	p.patient_id,min(e.encounter_datetime) data_inicio\n"
          + "				from patient p \n"
          + "				inner join encounter e on p.patient_id=e.patient_id	\n"
          + "				inner join obs o on o.encounter_id=e.encounter_id\n"
          + "				where e.voided=0 and o.voided=0 and p.voided=0 \n"
          + "				and e.encounter_type in (18,6,9) \n"
          + "				and o.concept_id=1255 \n"
          + "				and o.value_coded=1256 \n"
          + "				and e.encounter_datetime<=:endDate \n"
          + "				and e.location_id=:location\n"
          + "				group by p.patient_id\n"
          + "		\n"
          + "				union\n"
          + "		\n"
          + "				Select p.patient_id,min(value_datetime) data_inicio\n"
          + "				from patient p\n"
          + "				inner join encounter e on p.patient_id=e.patient_id\n"
          + "				inner join obs o on e.encounter_id=o.encounter_id\n"
          + "				where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "				and e.encounter_type in (18,6,9,53) \n"
          + "				and o.concept_id=1190 \n"
          + "				and o.value_datetime is not null \n"
          + "				and o.value_datetime<=:endDate \n"
          + "				and e.location_id=:location\n"
          + "				group by p.patient_id\n"
          + "\n"
          + "				union\n"
          + "\n"
          + "				select pg.patient_id,date_enrolled data_inicio\n"
          + "				from patient p inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "				where pg.voided=0 and p.voided=0 \n"
          + "				and program_id=2 \n"
          + "				and date_enrolled<=:endDate \n"
          + "				and location_id=:location\n"
          + "				\n"
          + "				union\n"
          + "				\n"
          + "				\n"
          + "				SELECT e.patient_id, MIN(e.encounter_datetime) AS data_inicio \n"
          + "				FROM patient p\n"
          + "				inner join encounter e on p.patient_id=e.patient_id\n"
          + "				WHERE p.voided=0 AND e.voided=0 \n"
          + "				and e.encounter_type in (18,52) \n"
          + "				and e.encounter_datetime<=:endDate \n"
          + "				and e.location_id=:location\n"
          + "				GROUP BY p.patient_id\n"
          + "			) inicio0\n"
          + "			group by patient_id	\n"
          + "		)inicio1\n"
          + "		where data_inicio between :startDate and :endDate\n"
          + "	)inicio\n"
          + "	inner join\n"
          + "	(\n"
          + "		select p.patient_id,o1.value_text as telefone\n"
          + "		from patient p \n"
          + "		inner join encounter e on e.patient_id=p.patient_id\n"
          + "		left join obs o1 on o1.encounter_id=e.encounter_id and o1.concept_id=1611\n"
          + "		where e.voided=0 and p.voided=0 \n"
          + "		and e.encounter_type in (5,7) \n"
          + "		and e.encounter_datetime<=:endDate \n"
          + "		and e.location_id = :location\n"
          + "\n"
          + "		union\n"
          + "\n"
          + "		select pg.patient_id, null as telefone\n"
          + "		from patient p inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "		where pg.voided=0 and p.voided=0 \n"
          + "		and program_id=1 \n"
          + "		and date_enrolled<=:endDate \n"
          + "		and location_id=:location\n"
          + "		\n"
          + "		union\n"
          + "\n"
          + "		Select 	e.patient_id, o2.value_text as telefone\n"
          + "		from encounter e\n"
          + "		left join obs o2 on o2.encounter_id=e.encounter_id and o2.concept_id=6224\n"
          + "		where e.encounter_type = 53 \n"
          + "		and e.voided=0\n"
          + "		and e.encounter_datetime < :endDate \n"
          + "		and e.location_id=:location\n"
          + "	)inscricao on inicio.patient_id=inscricao.patient_id\n"
          + "	left join\n"
          + "	(	select max_frida.patient_id,max_frida.ultimo_levantamento,o.value_datetime,\n"
          + "		case o1.value_coded\n"
          + "			when 1651 then 'ZT+3TC+NVP'			\n"
          + "			when 1703 then 'AZT+3TC+EFV'\n"
          + "			when 6100 then 'AZT+3TC+LPV/r'\n"
          + "			when 6104 then 'ABC+3TC+EFV'\n"
          + "			when 6104 then 'ABC+3TC+EFV'\n"
          + "			when 6105 then 'ABC+3TC+NVP'\n"
          + "			when 6106 then 'ABC+3TC+LPV/r'\n"
          + "			when 6108 then 'TDF+3TC+LPV/r (2ª LINHA)'\n"
          + "			when 6116 then 'AZT+3TC+ABC'\n"
          + "			when 6243 then 'TDF+3TC+NVP'\n"
          + "			when 6324 then 'TDF+3TC+EFV'\n"
          + "			when 6329 then 'TDF+3TC+RAL+DRV/r'\n"
          + "			when 23784 then 'TDF+3TC+DTG'\n"
          + "			when 23786 then 'ABC+3TC+DTG'\n"
          + "			when 23790 then 'TDF+3TC+LPV/r+RTV'\n"
          + "			when 23791 then 'TDF+3TC+ATV/r'\n"
          + "			when 23792 then 'ABC+3TC+ATV/r'\n"
          + "			when 23793 then 'AZT+3TC+ATV/r'\n"
          + "			when 23795 then 'ABC+3TC+ATV/r+RAL'\n"
          + "			when 23796 then 'TDF+3TC+ATV/r+RAL'\n"
          + "			when 23797 then 'ABC+3TC+DRV/r+RAL'\n"
          + "			when 23798 then '3TC+RAL+DRV/r'\n"
          + "			when 23801 then 'AZT+3TC+RAL'\n"
          + "			when 23802 then 'AZT+3TC+DRV/r'\n"
          + "			when 23803 then 'AZT+3TC+RAL+DRV/r'\n"
          + "			when 23815 then 'AZT+3TC+DTG'\n"
          + "		else 'OUTRO' end as ultimo_regime,\n"
          + "		max_frida.ultimo_levantamento data_regime\n"
          + "		from\n"
          + "		(	Select p.patient_id,max(encounter_datetime) ultimo_levantamento\n"
          + "			from patient p \n"
          + "			inner join encounter e on e.patient_id=p.patient_id\n"
          + "			where p.voided=0 and e.voided=0 \n"
          + "			and e.encounter_type = 18 \n"
          + "			and e.location_id=:location \n"
          + "			and e.encounter_datetime<=:dateCoorte\n"
          + "			group by p.patient_id\n"
          + "		) max_frida \n"
          + "		left join obs o on o.person_id=max_frida.patient_id and max_frida.ultimo_levantamento=o.obs_datetime and o.voided=0 and o.concept_id=5096\n"
          + "		left join obs o1 on o1.person_id=max_frida.patient_id and max_frida.ultimo_levantamento=o1.obs_datetime and o1.voided=0 and o1.concept_id=1088		\n"
          + "	) ultimo on inicio.patient_id=ultimo.patient_id\n"
          + "	left join\n"
          + "	(	select max_seguimento.patient_id,max_seguimento.ultimo_seguimento,o.value_datetime\n"
          + "		from\n"
          + "		(	Select p.patient_id,max(encounter_datetime) ultimo_seguimento\n"
          + "			from patient p \n"
          + "			inner join encounter e on e.patient_id=p.patient_id\n"
          + "			where p.voided=0 and e.voided=0 \n"
          + "			and e.encounter_type in (6,9) \n"
          + "			and e.location_id=:location \n"
          + "			and e.encounter_datetime<=:endDate\n"
          + "			group by p.patient_id\n"
          + "		) max_seguimento \n"
          + "		left join obs o on o.person_id=max_seguimento.patient_id and max_seguimento.ultimo_seguimento=o.obs_datetime and o.voided=0 and o.concept_id=1410		\n"
          + "	) seguimento on inicio.patient_id=seguimento.patient_id\n"
          + "	left join	\n"
          + "	(	select 	pg.patient_id,ps.start_date encounter_datetime,location_id,\n"
          + "		case ps.state\n"
          + "		when 7 then 'TRANSFERIDO PARA'\n"
          + "		when 8 then 'SUSPENSO'\n"
          + "		when 9 then 'ABANDONO'\n"
          + "		when 10 then 'OBITO'\n"
          + "		else 'OUTRO' end as estado\n"
          + "		from patient p \n"
          + "		inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "		inner join patient_state ps on pg.patient_program_id=ps.patient_program_id\n"
          + "		where pg.voided=0 and ps.voided=0 and p.voided=0 \n"
          + "		and ps.start_date<=:dateCoorte \n"
          + "		and pg.program_id=2 \n"
          + "		and ps.state in (7,8,9,10) \n"
          + "		and ps.end_date is null \n"
          + "		and location_id=:location\n"
          + "	) saida_real on inicio.patient_id=saida_real.patient_id\n"
          + "	left join\n"
          + "	(\n"
          + "		Select p.patient_id,max(o.value_datetime) ultimo_levantamento\n"
          + "		from patient p \n"
          + "		inner join encounter e on e.patient_id=p.patient_id\n"
          + "		inner join obs o on e.encounter_id=o.encounter_id\n"
          + "		where p.voided=0 and e.voided=0 \n"
          + "		and e.encounter_type = 52\n"
          + "		and o.concept_id=23866 \n"
          + "		and o.value_datetime is not null\n"
          + "		and e.location_id=:location \n"
          + "		and e.encounter_datetime<=:dateCoorte\n"
          + "		group by p.patient_id\n"
          + "	) recepcao_levantamento on inicio.patient_id=recepcao_levantamento.patient_id\n"
          + "	left join \n"
          + "	(\n"
          + "		Select p.patient_id,e.encounter_datetime\n"
          + "		from patient p \n"
          + "		inner join encounter e on p.patient_id=e.patient_id\n"
          + "		inner join obs o on e.encounter_id=o.encounter_id\n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "		and concept_id=1982 \n"
          + "		and value_coded=44 \n"
          + "		and e.encounter_type in (5,6) \n"
          + "		and e.encounter_datetime between :startDate and :endDate \n"
          + "		and e.location_id=:location\n"
          + "\n"
          + "		union		\n"
          + "				\n"
          + "		Select p.patient_id,e.encounter_datetime\n"
          + "		from patient p inner join encounter e on p.patient_id=e.patient_id\n"
          + "		inner join obs o on e.encounter_id=o.encounter_id\n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "		and concept_id=1279 \n"
          + "		and e.encounter_type in (5,6) \n"
          + "		and e.encounter_datetime between :startDate and :endDate \n"
          + "		and e.location_id=:location\n"
          + "\n"
          + "		union		\n"
          + "				\n"
          + "		Select p.patient_id,e.encounter_datetime\n"
          + "		from patient p inner join encounter e on p.patient_id=e.patient_id\n"
          + "		inner join obs o on e.encounter_id=o.encounter_id\n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "		and concept_id=1600 \n"
          + "		and e.encounter_type in (5,6) \n"
          + "		and e.encounter_datetime between :startDate and :endDate \n"
          + "		and e.location_id=:location		\n"
          + "				\n"
          + "		union\n"
          + "				\n"
          + "		select pp.patient_id,pp.date_enrolled\n"
          + "		from patient_program pp \n"
          + "		where pp.program_id=8 and pp.voided=0 \n"
          + "		and pp.date_enrolled between :startDate and :endDate \n"
          + "		and pp.location_id=:location\n"
          + "\n"
          + "		union\n"
          + "\n"
          + "		select max_gravidez.patient_id,max_gravidez.ultimo_estado_gravidez\n"
          + "		from\n"
          + "		(	Select p.patient_id,max(obs_datetime) ultimo_estado_gravidez\n"
          + "			from patient p \n"
          + "			inner join encounter e on p.patient_id=e.patient_id\n"
          + "			inner join obs o on e.encounter_id=o.encounter_id\n"
          + "			where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "			and concept_id=5272\n"
          + "			and value_coded=1065 \n"
          + "			and e.encounter_type = 53 \n"
          + "			and o.obs_datetime <= :endDate \n"
          + "			and e.location_id=:location\n"
          + "			group by patient_id\n"
          + "		) max_gravidez \n"
          + "		left join obs o on o.person_id=max_gravidez.patient_id and max_gravidez.ultimo_estado_gravidez=o.obs_datetime and o.voided=0 and o.concept_id=5272	\n"
          + "	) gravida on gravida.patient_id= inicio.patient_id\n"
          + "	left join\n"
          + "	(\n"
          + "		select patient_id, referencia, max(date_created), data_inicio_programa\n"
          + "		from(\n"
          + "			select p.patient_id, pr.name referencia, max(pp.date_enrolled) as data_inicio_programa, pp.date_created\n"
          + "			from patient p\n"
          + "			inner join patient_program pp on pp.patient_id=p.patient_id\n"
          + "			inner join program pr on pr.program_id=pp.program_id\n"
          + "			where pp.date_enrolled < :endDate\n"
          + "			and pp.date_completed is null\n"
          + "			and pp.location_id=:location\n"
          + "			and p.voided=0 and pp.voided=0\n"
          + "			group by patient_id,pr.name\n"
          + "		) a group by patient_id\n"
          + "	) proveniencia on proveniencia.patient_id=inicio.patient_id\n"
          + "	left join \n"
          + "	(	select pad1.*\n"
          + "		from person_address pad1\n"
          + "		inner join \n"
          + "		(\n"
          + "			select person_id,min(person_address_id) id \n"
          + "			from person_address\n"
          + "			where voided=0\n"
          + "			group by person_id\n"
          + "		) pad2\n"
          + "		where pad1.person_id=pad2.person_id and pad1.person_address_id=pad2.id\n"
          + "	) pad3 on pad3.person_id=inicio.patient_id				\n"
          + "	left join 			\n"
          + "	(	select pn1.*\n"
          + "		from person_name pn1\n"
          + "		inner join \n"
          + "		(\n"
          + "			select person_id,min(person_name_id) id \n"
          + "			from person_name\n"
          + "			where voided=0\n"
          + "			group by person_id\n"
          + "		) pn2\n"
          + "		where pn1.person_id=pn2.person_id and pn1.person_name_id=pn2.id\n"
          + "	) pn on pn.person_id=inicio.patient_id			\n"
          + "	left join\n"
          + "	(   select pid1.*\n"
          + "		from patient_identifier pid1\n"
          + "		inner join\n"
          + "		(\n"
          + "			select patient_id,min(patient_identifier_id) id\n"
          + "			from patient_identifier\n"
          + "			where voided=0\n"
          + "			group by patient_id\n"
          + "		) pid2\n"
          + "		where pid1.patient_id=pid2.patient_id and pid1.patient_identifier_id=pid2.id\n"
          + "	) pid on pid.patient_id=inicio.patient_id	\n"
          + "	left join person pr on pr.person_id=inicio.patient_id\n"
          + "	left join person_attribute pat on pat.person_id=inicio.patient_id and pat.person_attribute_type_id=9 and pat.value is not null and pat.value<>'' and pat.voided=0\n"
          + "	left join\n"
          + "	(\n"
          + "		select p.patient_id, o.value_text as telefone\n"
          + "		from patient p\n"
          + "		inner join encounter e on e.patient_id=p.patient_id\n"
          + "		inner join obs o on o.encounter_id=e.encounter_id \n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0\n"
          + "		and e.encounter_type=34\n"
          + "		and o.concept_id=1611\n"
          + "		and e.location_id=:location\n"
          + "	) confidente on inicio.patient_id=confidente.patient_id\n"
          + ") coortes\n"
          + "group by patient_id";

  /** Visitas com rastreios e profilaxias */
  public static final String VISITAS_RASTREIOS_PROFILAXIAS =
      "select 	pid.identifier nid,\n"
          + "		visita.patient_id,\n"
          + "		visita.data_visita,\n"
          + "		ultimo_seguimento.data_ultimo_seguimento,\n"
          + "		rastreiotb.ultimo_rastreio_tb,\n"
          + "		rastreioits.ultimo_rastreio_its,\n"
          + "		profilaxiactx.data_profilaxia_ctx,\n"
          + "		if(profilaxiactx.tipo=1256,'I', if(profilaxiactx.tipo=1257,'C',if(profilaxiactx.tipo=1267,'F',''))) as ctx_tipo,\n"
          + "		profilaxiainh.data_profilaxia_inh,\n"
          + "		if(profilaxiainh.tipo=1256,'I', if(profilaxiainh.tipo=1257,'C',if(profilaxiainh.tipo=1267,'F',''))) as inh_tipo,\n"
          + "		concat(ifnull(pn.given_name,''),' ',ifnull(pn.middle_name,''),' ',ifnull(pn.family_name,'')) as NomeCompleto,\n"
          + "		if(elegivelctx.patient_id is not null,'SIM',null) elegivel_ctx,\n"
          + "		pe.gender,\n"
          + "		round(datediff(:endDate,pe.birthdate)/365) idade\n"
          + "from\n"
          + "( 	select e.patient_id, max(e.encounter_datetime) data_visita\n"
          + "	from patient p\n"
          + "	inner join encounter e on e.patient_id=p.patient_id\n"
          + "	where e.encounter_datetime between :startDate and :endDate \n"
          + "	and e.voided=0 and p.voided=0 \n"
          + "	and e.location_id=:location \n"
          + "	and e.encounter_type in (5,7,6,9,18,13,52,53)\n"
          + "	group by e.patient_id\n"
          + ") visita\n"
          + "left join \n"
          + "(	select e.patient_id, max(e.encounter_datetime) data_ultimo_seguimento\n"
          + "	from patient p\n"
          + "	inner join encounter e on e.patient_id=p.patient_id\n"
          + "	where e.encounter_datetime between :startDate and :endDate \n"
          + "	and e.voided=0 and p.voided=0 \n"
          + "	and e.location_id=:location \n"
          + "	and e.encounter_type in (6,9)\n"
          + "	group by e.patient_id\n"
          + ") ultimo_seguimento on visita.patient_id=ultimo_seguimento.patient_id\n"
          + "left join\n"
          + "(	select e.patient_id, max(e.encounter_datetime) ultimo_rastreio_tb\n"
          + "	from patient p\n"
          + "	inner join encounter e on e.patient_id=p.patient_id\n"
          + "	inner join obs o on o.encounter_id=e.encounter_id\n"
          + "	where e.encounter_datetime between :startDate and :endDate \n"
          + "	and e.voided=0 and p.voided=0 and o.voided=0 \n"
          + "	and e.location_id=:location \n"
          + "	and e.encounter_type in (6,9) \n"
          + "	and o.concept_id in (6257,23758)					\n"
          + "	group by e.patient_id\n"
          + ") rastreiotb on visita.patient_id=rastreiotb.patient_id\n"
          + "left join\n"
          + "(	select e.patient_id, max(e.encounter_datetime) ultimo_rastreio_its\n"
          + "	from patient p\n"
          + "	inner join encounter e on e.patient_id=p.patient_id\n"
          + "	inner join obs o on o.encounter_id=e.encounter_id\n"
          + "	where e.encounter_datetime between :startDate and :endDate \n"
          + "	and e.voided=0 and p.voided=0 and o.voided=0 \n"
          + "	and e.location_id=:location \n"
          + "	and e.encounter_type in (6,9) \n"
          + "	and (o.concept_id=6258 \n"
          + "			or (o.concept_id=23738 and o.value_coded in (1065,1066)))			\n"
          + "	group by e.patient_id\n"
          + ") rastreioits on visita.patient_id=rastreioits.patient_id\n"
          + "left join\n"
          + "(	select e.patient_id, max(e.encounter_datetime) data_profilaxia_ctx, o.value_coded as tipo\n"
          + "	from patient p\n"
          + "	inner join encounter e on e.patient_id=p.patient_id\n"
          + "	inner join obs o on o.encounter_id=e.encounter_id\n"
          + "	where e.encounter_datetime between :startDate and :endDate \n"
          + "	and e.voided=0 and p.voided=0 and o.voided=0 \n"
          + "	and e.location_id=:location \n"
          + "	and e.encounter_type in (6,9) \n"
          + "	and o.concept_id=6121 \n"
          + "	and o.value_coded in (1065,1256,1257,1267)					\n"
          + "	group by e.patient_id\n"
          + ") profilaxiactx on visita.patient_id=profilaxiactx.patient_id  \n"
          + "left join\n"
          + "(	select e.patient_id, max(e.encounter_datetime) data_profilaxia_inh, o.value_coded as tipo\n"
          + "	from patient p\n"
          + "	inner join encounter e on e.patient_id=p.patient_id\n"
          + "	inner join obs o on o.encounter_id=e.encounter_id\n"
          + "	where e.encounter_datetime between :startDate and :endDate \n"
          + "	and e.voided=0 and p.voided=0 and o.voided=0 \n"
          + "	and e.location_id=:location \n"
          + "	and e.encounter_type in (6,9) \n"
          + "	and o.concept_id=6122 \n"
          + "	and o.value_coded in (1065,1256,1257,1267)\n"
          + "	group by e.patient_id\n"
          + ") profilaxiainh on visita.patient_id=profilaxiainh.patient_id				\n"
          + "left join 			\n"
          + "(	select pn1.*\n"
          + "	from person_name pn1\n"
          + "	inner join \n"
          + "	(\n"
          + "		select person_id,min(person_name_id) id \n"
          + "		from person_name\n"
          + "		where voided=0\n"
          + "		group by person_id\n"
          + "	) pn2\n"
          + "	where pn1.person_id=pn2.person_id and pn1.person_name_id=pn2.id\n"
          + ") pn on pn.person_id=visita.patient_id			\n"
          + "left join\n"
          + "(   select pid1.*\n"
          + "	from patient_identifier pid1\n"
          + "	inner join\n"
          + "	(\n"
          + "		select patient_id,min(patient_identifier_id) id\n"
          + "		from patient_identifier\n"
          + "		where voided=0\n"
          + "		group by patient_id\n"
          + "	) pid2\n"
          + "	where pid1.patient_id=pid2.patient_id and pid1.patient_identifier_id=pid2.id\n"
          + ") pid on pid.patient_id=visita.patient_id\n"
          + "left join person pe on pe.person_id=visita.patient_id\n"
          + "left join 		\n"
          + "(	select o.person_id patient_id\n"
          + "	from obs o,				\n"
          + "	(	select p.patient_id,max(encounter_datetime) as encounter_datetime\n"
          + "		from patient p\n"
          + "		inner join encounter e on p.patient_id=e.patient_id\n"
          + "		inner join obs o on o.encounter_id=e.encounter_id\n"
          + "		where encounter_type=13 \n"
          + "		and e.voided=0 and p.voided=0 and o.voided=0  \n"
          + "		and encounter_datetime <=:endDate \n"
          + "		and e.location_id=:location\n"
          + "		and o.concept_id=5497\n"
          + "		group by patient_id\n"
          + "	) d\n"
          + "	where o.person_id=d.patient_id \n"
          + "	and o.obs_datetime=d.encounter_datetime \n"
          + "	and o.voided=0 \n"
          + "	and o.concept_id=5497 \n"
          + "	and o.location_id=:location \n"
          + "	and o.value_numeric<=350\n"
          + "	\n"
          + "	union\n"
          + "	\n"
          + "	select 	o.person_id patient_id\n"
          + "	from 	obs o,				\n"
          + "	(	select p.patient_id,max(encounter_datetime) as encounter_datetime\n"
          + "		from patient p\n"
          + "		inner join encounter e on p.patient_id=e.patient_id\n"
          + "		inner join obs o on o.encounter_id=e.encounter_id\n"
          + "		where encounter_type in (6,9) \n"
          + "		and e.voided=0 \n"
          + "		and encounter_datetime<=:endDate \n"
          + "		and e.location_id=:location\n"
          + "		and p.voided=0 and o.voided=0 \n"
          + "		and o.concept_id=5356\n"
          + "		group by patient_id\n"
          + "	) d\n"
          + "	where o.person_id=d.patient_id \n"
          + "	and o.obs_datetime=d.encounter_datetime \n"
          + "	and o.voided=0 \n"
          + "	and o.concept_id=5356 \n"
          + "	and o.location_id=:location \n"
          + "	and o.value_coded in (1206,1207)\n"
          + "			\n"
          + "	union\n"
          + "	\n"
          + "	select o.person_id patient_id\n"
          + "	from obs o,				\n"
          + "	(	select 	p.patient_id,max(encounter_datetime) as encounter_datetime\n"
          + "		from patient p\n"
          + "		inner join encounter e on p.patient_id=e.patient_id\n"
          + "		inner join obs o on o.encounter_id=e.encounter_id\n"
          + "		where encounter_type in (6,9) \n"
          + "		and e.voided=0 and p.voided=0 and o.voided=0 \n"
          + "		and encounter_datetime<=:endDate \n"
          + "		and e.location_id=:location\n"
          + "		and o.concept_id=5356\n"
          + "		group by patient_id\n"
          + "	) d\n"
          + "	where o.person_id=d.patient_id \n"
          + "	and o.obs_datetime=d.encounter_datetime \n"
          + "	and o.voided=0 \n"
          + "	and o.concept_id=5356 \n"
          + "	and o.location_id=:location \n"
          + "	and o.value_coded=1205 \n"
          + "	and d.patient_id not in (select distinct person_id from obs where concept_id=5497 and voided=0)\n"
          + "\n"
          + "	union\n"
          + "\n"
          + "	Select p.patient_id\n"
          + "	from patient p \n"
          + "	inner join encounter e on p.patient_id=e.patient_id	\n"
          + "	inner join obs o on o.encounter_id=e.encounter_id\n"
          + "	where e.voided=0 and o.voided=0 \n"
          + "	and o.value_datetime between :startDate and :endDate \n"
          + "	and o.concept_id=1113 \n"
          + "	and e.encounter_type in (6,9) \n"
          + "	and e.location_id=:location	\n"
          + "\n"
          + "	union		\n"
          + "\n"
          + "	select pg.patient_id\n"
          + "	from patient p inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "	where pg.voided=0 and p.voided=0 \n"
          + "	and program_id in (5,8) \n"
          + "	and date_enrolled between :startDate and :endDate \n"
          + "	and location_id=:location\n"
          + "\n"
          + "	union\n"
          + "\n"
          + "	select p.patient_id\n"
          + "	from person pe inner join patient p on p.patient_id=pe.person_id\n"
          + "	where pe.voided=0 and p.voided=0 \n"
          + "	and (datediff(:endDate,birthdate)/365)<5\n"
          + "	\n"
          + ") elegivelctx on elegivelctx.patient_id=visita.patient_id";

  /** Pacientes suspeitos de falência terapêutica */
  public static final String SUSPEITOS_FALENCIA =
      "select inicio.patient_id, \n"
          + "data_inicio,\n"
          + "ultimo.ultimo_levantamento ultimo_lev,\n"
          + "ultimo.value_datetime proximo_lev,\n"
          + "pid.identifier nid,\n"
          + "pad3.address6 localidade,\n"
          + "pad3.address5 bairro,\n"
          + "pad3.address3 celula,\n"
          + "pad3.address1 ponto_referencia,\n"
          + "pat.value as telefone,\n"
          + "confidente.telefone as telefone_confidente,\n"
          + "inscricao.telefone as telefone_referencia,\n"
          + "concat(ifnull(pn.given_name,''),' ',ifnull(pn.middle_name,''),' ',ifnull(pn.family_name,'')) as nome_completo,\n"
          + "pr.gender as genero,\n"
          + "round(datediff(current_date,pr.birthdate)/365) idade_actual,\n"
          + "if(gravida.patient_id is not null,'SIM','') gravida,\n"
          + "if(lactante.patient_id is not null and gravida.patient_id is null,'SIM','') lactante,\n"
          + "proveniencia.referencia as proveniencia,\n"
          + "ultimo.ultimo_regime as regime,\n"
          + "ultima_cv.data_carga as data_ultima_cv, \n"
          + "ultima_cv.cv as ultima_cv, \n"
          + "penultima_cv.data_carga as data_penultima_cv, \n"
          + "penultima_cv.cv as penultima_cv, \n"
          + "primeiro_cd4.data_cd4 as data_primeiro_cd4, \n"
          + "primeiro_cd4.cd4 as primeiro_cd4, \n"
          + "ultimo_cd4.data_cd4 as data_ultimo_cd4, \n"
          + "ultimo_cd4.cd4 as ultimo_cd4\n"
          + "from(	\n"
          + "	select patient_id,data_inicio\n"
          + "	from\n"
          + "	(	Select patient_id,min(data_inicio) data_inicio\n"
          + "		from\n"
          + "		(	Select 	p.patient_id,min(e.encounter_datetime) data_inicio\n"
          + "			from patient p \n"
          + "			inner join encounter e on p.patient_id=e.patient_id	\n"
          + "			inner join obs o on o.encounter_id=e.encounter_id\n"
          + "			where e.voided=0 and o.voided=0 and p.voided=0 \n"
          + "			and e.encounter_type in (18,6,9) \n"
          + "			and o.concept_id=1255 \n"
          + "			and o.value_coded=1256 \n"
          + "			and e.encounter_datetime<=:endDate \n"
          + "			and e.location_id=:location\n"
          + "			group by p.patient_id\n"
          + "	\n"
          + "			union\n"
          + "	\n"
          + "			Select p.patient_id,min(value_datetime) data_inicio\n"
          + "			from patient p\n"
          + "			inner join encounter e on p.patient_id=e.patient_id\n"
          + "			inner join obs o on e.encounter_id=o.encounter_id\n"
          + "			where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "			and e.encounter_type in (18,6,9,53) \n"
          + "			and o.concept_id=1190 \n"
          + "			and o.value_datetime is not null \n"
          + "			and o.value_datetime<=:endDate \n"
          + "			and e.location_id=:location\n"
          + "			group by p.patient_id\n"
          + "\n"
          + "			union\n"
          + "\n"
          + "			select pg.patient_id,date_enrolled data_inicio\n"
          + "			from patient p inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "			where pg.voided=0 and p.voided=0 \n"
          + "			and program_id=2 \n"
          + "			and date_enrolled<=:endDate \n"
          + "			and location_id=:location\n"
          + "			\n"
          + "			union\n"
          + "			\n"
          + "			SELECT e.patient_id, MIN(e.encounter_datetime) AS data_inicio \n"
          + "			FROM patient p\n"
          + "			inner join encounter e on p.patient_id=e.patient_id\n"
          + "			WHERE p.voided=0 AND e.voided=0 \n"
          + "			and e.encounter_type in (18,52) \n"
          + "			and e.encounter_datetime<=:endDate \n"
          + "			and e.location_id=:location\n"
          + "			GROUP BY 	p.patient_id\n"
          + "		) inicio0\n"
          + "		group by patient_id	\n"
          + "	)inicio1\n"
          + ")inicio\n"
          + "inner join\n"
          + "(\n"
          + "	select p.patient_id,o1.value_text as telefone\n"
          + "	from patient p \n"
          + "	inner join encounter e on e.patient_id=p.patient_id\n"
          + "	left join obs o1 on o1.encounter_id=e.encounter_id and o1.concept_id=1611\n"
          + "	where e.voided=0 and p.voided=0 \n"
          + "	and e.encounter_type in (5,7) \n"
          + "	and e.encounter_datetime<=:endDate \n"
          + "	and e.location_id = :location\n"
          + "\n"
          + "	union\n"
          + "\n"
          + "	select pg.patient_id, null as telefone\n"
          + "	from patient p inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "	where pg.voided=0 and p.voided=0 \n"
          + "	and program_id=1 \n"
          + "	and date_enrolled<=:endDate \n"
          + "	and location_id=:location\n"
          + "	\n"
          + "	union\n"
          + "\n"
          + "	Select 	e.patient_id, o2.value_text as telefone\n"
          + "	from encounter e\n"
          + "	left join obs o2 on o2.encounter_id=e.encounter_id and o2.concept_id=6224\n"
          + "	where e.encounter_type = 53 \n"
          + "	and e.voided=0\n"
          + "	and e.encounter_datetime < :endDate \n"
          + "	and e.location_id=:location\n"
          + ")inscricao on inicio.patient_id=inscricao.patient_id\n"
          + "inner join\n"
          + "(\n"
          + "	Select ultima_carga.patient_id, data_carga, obs.value_numeric cv\n"
          + "	from\n"
          + "	(	Select p.patient_id,max(o.obs_datetime) data_carga\n"
          + "		from patient p\n"
          + "		inner join encounter e on p.patient_id=e.patient_id\n"
          + "		inner join obs o on e.encounter_id=o.encounter_id\n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "		and e.encounter_type in (13,6,9,53) \n"
          + "		and o.concept_id = 856 \n"
          + "		and o.value_numeric is not null \n"
          + "		and o.obs_datetime <= :endDate \n"
          + "		and e.location_id=:location\n"
          + "		group by p.patient_id\n"
          + "	) ultima_carga\n"
          + "	inner join obs on obs.person_id=ultima_carga.patient_id and obs.obs_datetime=ultima_carga.data_carga\n"
          + "	where obs.voided=0 \n"
          + "	and obs.concept_id = 856 \n"
          + "	and obs.location_id=:location \n"
          + "	--and obs.value_numeric>1000\n"
          + "	and obs.obs_datetime > date_add(:endDate, interval -1 year)\n"
          + "	--and round(datediff(:endDate,obs.obs_datetime)/365) <= 1\n"
          + "	group by patient_id\n"
          + ") ultima_cv on ultima_cv.patient_id=inicio.patient_id\n"
          + "inner join\n"
          + "(\n"
          + "	Select ultima_carga.patient_id, data_carga, obs.value_numeric cv\n"
          + "	from\n"
          + "	(	Select p.patient_id,max(o.obs_datetime) data_carga\n"
          + "		from patient p\n"
          + "		inner join encounter e on p.patient_id=e.patient_id\n"
          + "		inner join obs o on e.encounter_id=o.encounter_id\n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "		and e.encounter_type in (13,6,9,53) \n"
          + "		and o.concept_id = 856 \n"
          + "		and o.value_numeric is not null \n"
          + "		and o.obs_datetime <= date_add(:endDate, interval -1 year) \n"
          + "		and e.location_id=:location\n"
          + "		group by p.patient_id\n"
          + "	) ultima_carga\n"
          + "	inner join obs on obs.person_id=ultima_carga.patient_id and obs.obs_datetime=ultima_carga.data_carga\n"
          + "	where obs.voided=0 \n"
          + "	and obs.concept_id = 856 \n"
          + "	and obs.location_id=:location \n"
          + "	--and obs.value_numeric>1000\n"
          + "	and obs.obs_datetime > date_add(:endDate, interval -2 year)\n"
          + "	--and round(datediff(:endDate,obs.obs_datetime)/365) <= 1\n"
          + "	group by patient_id\n"
          + ") penultima_cv on penultima_cv.patient_id=inicio.patient_id\n"
          + "inner join\n"
          + "(\n"
          + "	Select cd4.patient_id, data_cd4, obs.value_numeric cd4\n"
          + "	from\n"
          + "	(	Select p.patient_id,min(o.obs_datetime) data_cd4\n"
          + "		from patient p\n"
          + "		inner join encounter e on p.patient_id=e.patient_id\n"
          + "		inner join obs o on e.encounter_id=o.encounter_id\n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "		and e.encounter_type in (13,6,9,53) \n"
          + "		and o.concept_id in (5497,1695) \n"
          + "		and o.value_numeric is not null \n"
          + "		and o.obs_datetime <= :endDate \n"
          + "		and e.location_id=:location\n"
          + "		group by p.patient_id\n"
          + "	) cd4\n"
          + "	inner join obs on obs.person_id=cd4.patient_id and obs.obs_datetime=cd4.data_cd4\n"
          + "	where obs.voided=0 \n"
          + "	and obs.concept_id in (5497,1695) \n"
          + "	and obs.location_id=:location \n"
          + "	group by patient_id\n"
          + ") primeiro_cd4 on primeiro_cd4.patient_id=inicio.patient_id\n"
          + "inner join\n"
          + "(\n"
          + "	Select cd4.patient_id, data_cd4, obs.value_numeric cd4\n"
          + "	from\n"
          + "	(	Select p.patient_id,max(o.obs_datetime) data_cd4\n"
          + "		from patient p\n"
          + "		inner join encounter e on p.patient_id=e.patient_id\n"
          + "		inner join obs o on e.encounter_id=o.encounter_id\n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "		and e.encounter_type in (13,6,9,53) \n"
          + "		and o.concept_id in (5497,1695) \n"
          + "		and o.value_numeric is not null \n"
          + "		and o.obs_datetime <= :endDate \n"
          + "		and e.location_id=:location\n"
          + "		group by p.patient_id\n"
          + "	) cd4\n"
          + "	inner join obs on obs.person_id=cd4.patient_id and obs.obs_datetime=cd4.data_cd4\n"
          + "	where obs.voided=0 \n"
          + "	and obs.concept_id in (5497,1695) \n"
          + "	and obs.location_id=:location \n"
          + "	group by patient_id\n"
          + ") ultimo_cd4 on ultimo_cd4.patient_id=inicio.patient_id and primeiro_cd4.data_cd4<ultimo_cd4.data_cd4\n"
          + "left join\n"
          + "(	select max_frida.patient_id,max_frida.ultimo_levantamento,o.value_datetime,\n"
          + "	case o1.value_coded\n"
          + "		when 1651 then 'ZT+3TC+NVP'			\n"
          + "		when 1703 then 'AZT+3TC+EFV'\n"
          + "		when 6100 then 'AZT+3TC+LPV/r'\n"
          + "		when 6104 then 'ABC+3TC+EFV'\n"
          + "		when 6104 then 'ABC+3TC+EFV'\n"
          + "		when 6105 then 'ABC+3TC+NVP'\n"
          + "		when 6106 then 'ABC+3TC+LPV/r'\n"
          + "		when 6108 then 'TDF+3TC+LPV/r (2ª LINHA)'\n"
          + "		when 6116 then 'AZT+3TC+ABC'\n"
          + "		when 6243 then 'TDF+3TC+NVP'\n"
          + "		when 6324 then 'TDF+3TC+EFV'\n"
          + "		when 6329 then 'TDF+3TC+RAL+DRV/r'\n"
          + "		when 23784 then 'TDF+3TC+DTG'\n"
          + "		when 23786 then 'ABC+3TC+DTG'\n"
          + "		when 23790 then 'TDF+3TC+LPV/r+RTV'\n"
          + "		when 23791 then 'TDF+3TC+ATV/r'\n"
          + "		when 23792 then 'ABC+3TC+ATV/r'\n"
          + "		when 23793 then 'AZT+3TC+ATV/r'\n"
          + "		when 23795 then 'ABC+3TC+ATV/r+RAL'\n"
          + "		when 23796 then 'TDF+3TC+ATV/r+RAL'\n"
          + "		when 23797 then 'ABC+3TC+DRV/r+RAL'\n"
          + "		when 23798 then '3TC+RAL+DRV/r'\n"
          + "		when 23801 then 'AZT+3TC+RAL'\n"
          + "		when 23802 then 'AZT+3TC+DRV/r'\n"
          + "		when 23803 then 'AZT+3TC+RAL+DRV/r'\n"
          + "		when 23815 then 'AZT+3TC+DTG'\n"
          + "	else 'OUTRO' end as ultimo_regime,\n"
          + "	max_frida.ultimo_levantamento data_regime\n"
          + "	from\n"
          + "	(	Select p.patient_id,max(encounter_datetime) ultimo_levantamento\n"
          + "		from patient p \n"
          + "		inner join encounter e on e.patient_id=p.patient_id\n"
          + "		where p.voided=0 and e.voided=0 \n"
          + "		and e.encounter_type = 18 \n"
          + "		and e.location_id=:location \n"
          + "		and e.encounter_datetime<=:endDate\n"
          + "		group by p.patient_id\n"
          + "	) max_frida \n"
          + "	left join obs o on o.person_id=max_frida.patient_id and max_frida.ultimo_levantamento=o.obs_datetime and o.voided=0 and o.concept_id=5096\n"
          + "	left join obs o1 on o1.person_id=max_frida.patient_id and max_frida.ultimo_levantamento=o1.obs_datetime and o1.voided=0 and o1.concept_id=1088		\n"
          + ") ultimo on inicio.patient_id=ultimo.patient_id	\n"
          + "left join \n"
          + "(\n"
          + "	Select p.patient_id,e.encounter_datetime\n"
          + "	from patient p \n"
          + "	inner join encounter e on p.patient_id=e.patient_id\n"
          + "	inner join obs o on e.encounter_id=o.encounter_id\n"
          + "	where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "	and concept_id=1982 \n"
          + "	and value_coded=44 \n"
          + "	and e.encounter_type in (5,6) \n"
          + "	and e.encounter_datetime between :startDate and :endDate \n"
          + "	and e.location_id=:location\n"
          + "\n"
          + "	union		\n"
          + "			\n"
          + "	Select p.patient_id,e.encounter_datetime\n"
          + "	from patient p inner join encounter e on p.patient_id=e.patient_id\n"
          + "	inner join obs o on e.encounter_id=o.encounter_id\n"
          + "	where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "	and concept_id=1279 \n"
          + "	and e.encounter_type in (5,6) \n"
          + "	and e.encounter_datetime between :startDate and :endDate \n"
          + "	and e.location_id=:location\n"
          + "\n"
          + "	union		\n"
          + "			\n"
          + "	Select p.patient_id,e.encounter_datetime\n"
          + "	from patient p inner join encounter e on p.patient_id=e.patient_id\n"
          + "	inner join obs o on e.encounter_id=o.encounter_id\n"
          + "	where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "	and concept_id=1600 \n"
          + "	and e.encounter_type in (5,6) \n"
          + "	and e.encounter_datetime between :startDate and :endDate \n"
          + "	and e.location_id=:location		\n"
          + "			\n"
          + "	union\n"
          + "			\n"
          + "	select pp.patient_id,pp.date_enrolled\n"
          + "	from patient_program pp \n"
          + "	where pp.program_id=8 and pp.voided=0 \n"
          + "	and pp.date_enrolled between :startDate and :endDate \n"
          + "	and pp.location_id=:location\n"
          + "\n"
          + "	union\n"
          + "\n"
          + "	select max_gravidez.patient_id,max_gravidez.ultimo_estado_gravidez\n"
          + "	from\n"
          + "	(	Select p.patient_id,max(obs_datetime) ultimo_estado_gravidez\n"
          + "		from patient p \n"
          + "		inner join encounter e on p.patient_id=e.patient_id\n"
          + "		inner join obs o on e.encounter_id=o.encounter_id\n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "		and concept_id=5272\n"
          + "		and value_coded=1065 \n"
          + "		and e.encounter_type = 53 \n"
          + "		and o.obs_datetime <= :endDate \n"
          + "		and e.location_id=:location\n"
          + "		group by patient_id\n"
          + "	) max_gravidez \n"
          + "	left join obs o on o.person_id=max_gravidez.patient_id and max_gravidez.ultimo_estado_gravidez=o.obs_datetime and o.voided=0 and o.concept_id=5272	\n"
          + ") gravida on gravida.patient_id= inicio.patient_id\n"
          + "left join\n"
          + "(\n"
          + "	Select p.patient_id\n"
          + "	from patient p\n"
          + "	inner join encounter e on p.patient_id=e.patient_id\n"
          + "	inner join obs o on e.encounter_id=o.encounter_id\n"
          + "	where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "	and e.encounter_type in (5,6) \n"
          + "	and o.concept_id=5599 \n"
          + "	and o.value_datetime is not null \n"
          + "	and o.value_datetime between :startDate and :endDate \n"
          + "	and e.location_id=:location\n"
          + "	group by p.patient_id\n"
          + "	\n"
          + "	union all\n"
          + "	\n"
          + "	select patient_id\n"
          + "	from\n"
          + "	(\n"
          + "		Select p.patient_id,max(obs_datetime) ultimo_estado_lactancia\n"
          + "		from patient p \n"
          + "		inner join encounter e on p.patient_id=e.patient_id\n"
          + "		inner join obs o on e.encounter_id=o.encounter_id\n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "		and concept_id=6332\n"
          + "		and value_coded=1065 \n"
          + "		and e.encounter_type in (6,53) \n"
          + "		and o.obs_datetime between :startDate and :endDate\n"
          + "		and e.location_id=:location\n"
          + "		group by patient_id\n"
          + "	) lactantes\n"
          + "	\n"
          + "	union all\n"
          + "	\n"
          + "	select patient_id\n"
          + "	from\n"
          + "	(\n"
          + "		Select p.patient_id,min(obs_datetime) primeiro_estado_lactancia\n"
          + "		from patient p \n"
          + "		inner join encounter e on p.patient_id=e.patient_id\n"
          + "		inner join obs o on e.encounter_id=o.encounter_id\n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "		and concept_id=6334\n"
          + "		and value_coded=6332 \n"
          + "		and e.encounter_type=6 \n"
          + "		and o.obs_datetime between :startDate and :endDate\n"
          + "		and e.location_id=:location\n"
          + "		group by patient_id\n"
          + "	) lactantes\n"
          + "	\n"
          + "	union all\n"
          + "	\n"
          + "	select pg.patient_id\n"
          + "	from patient p \n"
          + "	inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "	inner join patient_state ps on pg.patient_program_id=ps.patient_program_id\n"
          + "	where pg.voided=0 and ps.voided=0 and p.voided=0 and \n"
          + "	pg.program_id=8 \n"
          + "	and ps.state=27 \n"
          + "	and ps.end_date is null \n"
          + "	and ps.start_date between date_add(:startDate, interval -2 year) and date_add(:startDate, interval -1 day) \n"
          + "	and location_id=:location\n"
          + ") lactante on lactante.patient_id=inicio.patient_id\n"
          + "left join\n"
          + "(\n"
          + "	select patient_id, referencia, max(date_created), data_inicio_programa\n"
          + "	from(\n"
          + "		select p.patient_id, pr.name referencia, max(pp.date_enrolled) as data_inicio_programa, pp.date_created\n"
          + "		from patient p\n"
          + "		inner join patient_program pp on pp.patient_id=p.patient_id\n"
          + "		inner join program pr on pr.program_id=pp.program_id\n"
          + "		where pp.date_enrolled < :endDate\n"
          + "		and pp.date_completed is null\n"
          + "		and pp.location_id=:location\n"
          + "		and p.voided=0 and pp.voided=0\n"
          + "		group by patient_id,pr.name\n"
          + "	) a group by patient_id\n"
          + ") proveniencia on proveniencia.patient_id=inicio.patient_id\n"
          + "left join \n"
          + "(	select pad1.*\n"
          + "	from person_address pad1\n"
          + "	inner join \n"
          + "	(\n"
          + "		select person_id,min(person_address_id) id \n"
          + "		from person_address\n"
          + "		where voided=0\n"
          + "		group by person_id\n"
          + "	) pad2\n"
          + "	where pad1.person_id=pad2.person_id and pad1.person_address_id=pad2.id\n"
          + ") pad3 on pad3.person_id=inicio.patient_id				\n"
          + "left join 			\n"
          + "(	select pn1.*\n"
          + "	from person_name pn1\n"
          + "	inner join \n"
          + "	(\n"
          + "		select person_id,min(person_name_id) id \n"
          + "		from person_name\n"
          + "		where voided=0\n"
          + "		group by person_id\n"
          + "	) pn2\n"
          + "	where pn1.person_id=pn2.person_id and pn1.person_name_id=pn2.id\n"
          + ") pn on pn.person_id=inicio.patient_id			\n"
          + "left join\n"
          + "(   select pid1.*\n"
          + "	from patient_identifier pid1\n"
          + "	inner join\n"
          + "	(\n"
          + "		select patient_id,min(patient_identifier_id) id\n"
          + "		from patient_identifier\n"
          + "		where voided=0\n"
          + "		group by patient_id\n"
          + "	) pid2\n"
          + "	where pid1.patient_id=pid2.patient_id and pid1.patient_identifier_id=pid2.id\n"
          + ") pid on pid.patient_id=inicio.patient_id	\n"
          + "left join person pr on pr.person_id=inicio.patient_id\n"
          + "left join person_attribute pat on pat.person_id=inicio.patient_id and pat.person_attribute_type_id=9 and pat.value is not null and pat.value<>'' and pat.voided=0\n"
          + "left join\n"
          + "(\n"
          + "	select p.patient_id, o.value_text as telefone\n"
          + "	from patient p\n"
          + "	inner join encounter e on e.patient_id=p.patient_id\n"
          + "	inner join obs o on o.encounter_id=e.encounter_id \n"
          + "	where p.voided=0 and e.voided=0 and o.voided=0\n"
          + "	and e.encounter_type=34\n"
          + "	and o.concept_id=1611\n"
          + "	and e.location_id=:location\n"
          + ") confidente on inicio.patient_id=confidente.patient_id\n"
          + "where (datediff(:endDate,inicio.data_inicio)>=180 and ultima_cv.cv>1000 and penultima_cv.cv>1000 and ultimo_cd4.cd4 < primeiro_cd4.cd4\n"
          + "or (datediff(:endDate,inicio.data_inicio)>=365) and ultimo_cd4.cd4 <100)\n"
          + "and inicio.patient_id not in\n"
          + "(	select 	pg.patient_id\n"
          + "	from patient p \n"
          + "	inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "	inner join patient_state ps on pg.patient_program_id=ps.patient_program_id\n"
          + "	where pg.voided=0 and ps.voided=0 and p.voided=0 \n"
          + "	and ps.start_date<=:endDate \n"
          + "	and pg.program_id=2 \n"
          + "	and ps.state in (7,8,9,10) \n"
          + "	and ps.end_date is null \n"
          + "	and location_id=:location\n"
          + ")\n"
          + "group by patient_id";

  public static final String POP_CHAVE_GRUPOS_APOIO_MDS =
      "select * \n"
          + "from \n"
          + "(	select 	inicio.patient_id,\n"
          + "	inicio.data_inicio,\n"
          + "	ultimo.ultimo_levantamento ultimo_lev,\n"
          + "	ultimo.value_datetime proximo_lev,\n"
          + "	saida_real.encounter_datetime data_saida,\n"
          + "	pid.identifier nid,\n"
          + "	if(saida_real.estado is not null,saida_real.estado,if(ultimo.value_datetime is not null,if(datediff(:endDate,ultimo.value_datetime)>60,'ABANDONO NAO NOTIFICADO','ACTIVO'),'SEM DATA PROXIMA NO ULTIMO LEVANTAMENTO' )) estado,\n"
          + "	concat(ifnull(pn.given_name,''),' ',ifnull(pn.middle_name,''),' ',ifnull(pn.family_name,'')) as nome_completo,\n"
          + "	pr.gender as genero,\n"
          + "	round(datediff(current_date,pr.birthdate)/365) idade_actual,\n"
          + "	if(gravida.patient_id is not null,'SIM','') gravida,\n"
          + "	proveniencia.referencia as proveniencia,\n"
          + "	if(populacao_chave.key_pop='HSH','SIM','') as hsh,\n"
          + "	if(populacao_chave.key_pop='PID','SIM','') as pid,\n"
          + "	if(populacao_chave.key_pop='REC','SIM','') as rec,\n"
          + "	if(populacao_chave.key_pop='MTS','SIM','') as mts,\n"
          + "	if(populacao_chave.key_pop='Outro','SIM','') as outr,\n"
          + "	if(grupo_apoio.ga='CR','SIM','') as cr,\n"
          + "	if(grupo_apoio.ga='AR','SIM','') as ar,\n"
          + "	if(grupo_apoio.ga='PC','SIM','') as pc,\n"
          + "	if(grupo_apoio.ga='MPM','SIM','') as mpm,\n"
          + "	if(grupo_apoio.ga='Outro','SIM','') as ga_out,\n"
          + "	if(modelos_diferenciados.mds='GA','SIM','') as ga,\n"
          + "	if(modelos_diferenciados.mds='FR','SIM','') as fr,\n"
          + "	if(modelos_diferenciados.mds='AF','SIM','') as af,\n"
          + "	if(modelos_diferenciados.mds='DT','SIM','') as dt,\n"
          + "	if(modelos_diferenciados.mds='CA','SIM','') as ca,\n"
          + "	if(modelos_diferenciados.mds='DC','SIM','') as dc,\n"
          + "	if(modelos_diferenciados.mds='PU','SIM','') as pu,\n"
          + "	if(modelos_diferenciados.mds='DS','SIM','') as ds,\n"
          + "	if(modelos_diferenciados.mds='Outro','SIM','') as mds_out\n"
          + "	from		\n"
          + "	(	select patient_id,data_inicio\n"
          + "		from\n"
          + "		(	Select patient_id,min(data_inicio) data_inicio\n"
          + "			from\n"
          + "			(	Select 	p.patient_id,min(e.encounter_datetime) data_inicio\n"
          + "				from patient p \n"
          + "				inner join encounter e on p.patient_id=e.patient_id	\n"
          + "				inner join obs o on o.encounter_id=e.encounter_id\n"
          + "				where e.voided=0 and o.voided=0 and p.voided=0 \n"
          + "				and e.encounter_type in (18,6,9) \n"
          + "				and o.concept_id=1255 \n"
          + "				and o.value_coded=1256 \n"
          + "				and e.encounter_datetime<=:endDate \n"
          + "				and e.location_id=:location\n"
          + "				group by p.patient_id\n"
          + "		\n"
          + "				union\n"
          + "		\n"
          + "				Select p.patient_id,min(value_datetime) data_inicio\n"
          + "				from patient p\n"
          + "				inner join encounter e on p.patient_id=e.patient_id\n"
          + "				inner join obs o on e.encounter_id=o.encounter_id\n"
          + "				where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "				and e.encounter_type in (18,6,9,53) \n"
          + "				and o.concept_id=1190 \n"
          + "				and o.value_datetime is not null \n"
          + "				and o.value_datetime<=:endDate \n"
          + "				and e.location_id=:location\n"
          + "				group by p.patient_id\n"
          + "\n"
          + "				union\n"
          + "\n"
          + "				select pg.patient_id,date_enrolled data_inicio\n"
          + "				from patient p inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "				where pg.voided=0 and p.voided=0 \n"
          + "				and program_id=2 \n"
          + "				and date_enrolled<=:endDate \n"
          + "				and location_id=:location\n"
          + "				\n"
          + "				union\n"
          + "				\n"
          + "				\n"
          + "				SELECT e.patient_id, MIN(e.encounter_datetime) AS data_inicio \n"
          + "				FROM patient p\n"
          + "				inner join encounter e on p.patient_id=e.patient_id\n"
          + "				WHERE p.voided=0 AND e.voided=0 \n"
          + "				and e.encounter_type in (18,52) \n"
          + "				and e.encounter_datetime<=:endDate \n"
          + "				and e.location_id=:location\n"
          + "				GROUP BY p.patient_id\n"
          + "			) inicio0\n"
          + "			group by patient_id	\n"
          + "		)inicio1\n"
          + "		where data_inicio between :startDate and :endDate\n"
          + "	)inicio\n"
          + "	left join\n"
          + "	(\n"
          + "		select e.patient_id,\n"
          + "		case o.value_coded\n"
          + "		when 1377 then 'HSH'\n"
          + "		when 20454 then 'PID'\n"
          + "		when 20426 then 'REC'\n"
          + "		when 1901 then 'MTS'\n"
          + "		when 5622 then 'Outro' end as key_pop\n"
          + "		from patient p\n"
          + "		inner join encounter e on e.patient_id=p.patient_id\n"
          + "		inner join obs o on o.encounter_id=e.encounter_id\n"
          + "		where e.encounter_datetime between :startDate and :endDate\n"
          + "		and e.voided=0 and p.voided=0 and o.voided=0 \n"
          + "		and e.location_id=:location \n"
          + "		and e.encounter_type in (6,9,35) \n"
          + "		and o.concept_id=23703 \n"
          + "		and o.value_coded is not null\n"
          + "	) populacao_chave on inicio.patient_id=populacao_chave.patient_id\n"
          + "	left join\n"
          + "	(\n"
          + "		select e.patient_id,\n"
          + "		case o.concept_id\n"
          + "		when 23753 then 'CR'\n"
          + "		when 23757 then 'AR'\n"
          + "		when 23755 then 'PC'\n"
          + "		when 23759 then 'MPM'\n"
          + "		when 23772 then 'Outro' end as ga\n"
          + "		from patient p\n"
          + "		inner join encounter e on e.patient_id=p.patient_id\n"
          + "		inner join obs o on o.encounter_id=e.encounter_id\n"
          + "		where e.encounter_datetime between :startDate and :endDate\n"
          + "		and e.voided=0 and p.voided=0 and o.voided=0 \n"
          + "		and e.location_id=:location \n"
          + "		and e.encounter_type=35 \n"
          + "		and (o.concept_id in (23753,23755,23757,23759) and o.value_coded in (1256,1257)\n"
          + "			or (o.concept_id=23772 and o.value_text is not null))\n"
          + "		and e.patient_id not in\n"
          + "		(\n"
          + "			select e.patient_id\n"
          + "			from patient p\n"
          + "			inner join encounter e on e.patient_id=p.patient_id\n"
          + "			inner join obs o on o.encounter_id=e.encounter_id\n"
          + "			where e.encounter_datetime between :startDate and :endDate\n"
          + "			and e.voided=0 and p.voided=0 and o.voided=0 \n"
          + "			and e.location_id=:location \n"
          + "			and e.encounter_type=35 \n"
          + "			and o.concept_id in (23753,23755,23757,23759) and o.value_coded=1267\n"
          + "		)\n"
          + "	) grupo_apoio on inicio.patient_id=grupo_apoio.patient_id\n"
          + "	left join\n"
          + "	(\n"
          + "		select e.patient_id,\n"
          + "		case o.concept_id\n"
          + "		when 23724 then 'GA'\n"
          + "		when 23729 then 'FR'\n"
          + "		when 23725 then 'AF'\n"
          + "		when 23730 then 'DT'\n"
          + "		when 23726 then 'CA'\n"
          + "		when 23731 then 'DC'\n"
          + "		when 23727 then 'PU'\n"
          + "		when 23888 then 'PU'\n"
          + "		when 23732 then 'Outro' end as mds\n"
          + "		from patient p\n"
          + "		inner join encounter e on e.patient_id=p.patient_id\n"
          + "		inner join obs o on o.encounter_id=e.encounter_id\n"
          + "		where e.encounter_datetime between :startDate and :endDate\n"
          + "		and e.voided=0 and p.voided=0 and o.voided=0 \n"
          + "		and e.location_id=:location \n"
          + "		and e.encounter_type=35 \n"
          + "		and (o.concept_id in (23724,23729,23725,23730,23726,23731,23727,23888) and o.value_coded in (1256,1257)\n"
          + "			or (o.concept_id=23732 and o.value_text is not null))\n"
          + "		and e.patient_id not in\n"
          + "		(\n"
          + "			select e.patient_id\n"
          + "			from patient p\n"
          + "			inner join encounter e on e.patient_id=p.patient_id\n"
          + "			inner join obs o on o.encounter_id=e.encounter_id\n"
          + "			where e.encounter_datetime between :startDate and :endDate\n"
          + "			and e.voided=0 and p.voided=0 and o.voided=0 \n"
          + "			and e.location_id=:location \n"
          + "			and e.encounter_type=35 \n"
          + "			and o.concept_id in (23724,23729,23725,23730,23726,23731,23727,23888) and o.value_coded=1267\n"
          + "		)\n"
          + "	) modelos_diferenciados on inicio.patient_id=modelos_diferenciados.patient_id\n"
          + "	left join\n"
          + "	(	select max_frida.patient_id,max_frida.ultimo_levantamento,o.value_datetime\n"
          + "		from\n"
          + "		(	Select p.patient_id,max(encounter_datetime) ultimo_levantamento\n"
          + "			from patient p \n"
          + "			inner join encounter e on e.patient_id=p.patient_id\n"
          + "			where p.voided=0 and e.voided=0 \n"
          + "			and e.encounter_type = 18 \n"
          + "			and e.location_id=:location \n"
          + "			and e.encounter_datetime<=:endDate\n"
          + "			group by p.patient_id\n"
          + "		) max_frida \n"
          + "		left join obs o on o.person_id=max_frida.patient_id and max_frida.ultimo_levantamento=o.obs_datetime and o.voided=0 and o.concept_id=5096\n"
          + "		left join obs o1 on o1.person_id=max_frida.patient_id and max_frida.ultimo_levantamento=o1.obs_datetime and o1.voided=0 and o1.concept_id=1088		\n"
          + "	) ultimo on inicio.patient_id=ultimo.patient_id\n"
          + "	left join	\n"
          + "	(	select 	pg.patient_id,ps.start_date encounter_datetime,location_id,\n"
          + "		case ps.state\n"
          + "		when 7 then 'TRANSFERIDO PARA'\n"
          + "		when 8 then 'SUSPENSO'\n"
          + "		when 9 then 'ABANDONO'\n"
          + "		when 10 then 'OBITO'\n"
          + "		else 'OUTRO' end as estado\n"
          + "		from patient p \n"
          + "		inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "		inner join patient_state ps on pg.patient_program_id=ps.patient_program_id\n"
          + "		where pg.voided=0 and ps.voided=0 and p.voided=0 \n"
          + "		and ps.start_date<=:endDate \n"
          + "		and pg.program_id=2 \n"
          + "		and ps.state in (7,8,9,10) \n"
          + "		and ps.end_date is null \n"
          + "		and location_id=:location\n"
          + "	) saida_real on inicio.patient_id=saida_real.patient_id	\n"
          + "	left join \n"
          + "	(\n"
          + "		Select p.patient_id,e.encounter_datetime\n"
          + "		from patient p \n"
          + "		inner join encounter e on p.patient_id=e.patient_id\n"
          + "		inner join obs o on e.encounter_id=o.encounter_id\n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "		and concept_id=1982 \n"
          + "		and value_coded=44 \n"
          + "		and e.encounter_type in (5,6) \n"
          + "		and e.encounter_datetime between :startDate and :endDate \n"
          + "		and e.location_id=:location\n"
          + "\n"
          + "		union		\n"
          + "				\n"
          + "		Select p.patient_id,e.encounter_datetime\n"
          + "		from patient p inner join encounter e on p.patient_id=e.patient_id\n"
          + "		inner join obs o on e.encounter_id=o.encounter_id\n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "		and concept_id=1279 \n"
          + "		and e.encounter_type in (5,6) \n"
          + "		and e.encounter_datetime between :startDate and :endDate \n"
          + "		and e.location_id=:location\n"
          + "\n"
          + "		union		\n"
          + "				\n"
          + "		Select p.patient_id,e.encounter_datetime\n"
          + "		from patient p inner join encounter e on p.patient_id=e.patient_id\n"
          + "		inner join obs o on e.encounter_id=o.encounter_id\n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "		and concept_id=1600 \n"
          + "		and e.encounter_type in (5,6) \n"
          + "		and e.encounter_datetime between :startDate and :endDate \n"
          + "		and e.location_id=:location		\n"
          + "				\n"
          + "		union\n"
          + "				\n"
          + "		select pp.patient_id,pp.date_enrolled\n"
          + "		from patient_program pp \n"
          + "		where pp.program_id=8 and pp.voided=0 \n"
          + "		and pp.date_enrolled between :startDate and :endDate \n"
          + "		and pp.location_id=:location\n"
          + "\n"
          + "		union\n"
          + "\n"
          + "		select max_gravidez.patient_id,max_gravidez.ultimo_estado_gravidez\n"
          + "		from\n"
          + "		(	Select p.patient_id,max(obs_datetime) ultimo_estado_gravidez\n"
          + "			from patient p \n"
          + "			inner join encounter e on p.patient_id=e.patient_id\n"
          + "			inner join obs o on e.encounter_id=o.encounter_id\n"
          + "			where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "			and concept_id=5272\n"
          + "			and value_coded=1065 \n"
          + "			and e.encounter_type = 53 \n"
          + "			and o.obs_datetime <= :endDate \n"
          + "			and e.location_id=:location\n"
          + "			group by patient_id\n"
          + "		) max_gravidez \n"
          + "		left join obs o on o.person_id=max_gravidez.patient_id and max_gravidez.ultimo_estado_gravidez=o.obs_datetime and o.voided=0 and o.concept_id=5272	\n"
          + "	) gravida on gravida.patient_id= inicio.patient_id\n"
          + "	left join\n"
          + "	(\n"
          + "		select patient_id, referencia, max(date_created), data_inicio_programa\n"
          + "		from(\n"
          + "			select p.patient_id, pr.name referencia, max(pp.date_enrolled) as data_inicio_programa, pp.date_created\n"
          + "			from patient p\n"
          + "			inner join patient_program pp on pp.patient_id=p.patient_id\n"
          + "			inner join program pr on pr.program_id=pp.program_id\n"
          + "			where pp.date_enrolled < :endDate\n"
          + "			and pp.date_completed is null\n"
          + "			and pp.location_id=:location\n"
          + "			and p.voided=0 and pp.voided=0\n"
          + "			group by patient_id,pr.name\n"
          + "		) a group by patient_id\n"
          + "	) proveniencia on proveniencia.patient_id=inicio.patient_id				\n"
          + "	left join 			\n"
          + "	(	select pn1.*\n"
          + "		from person_name pn1\n"
          + "		inner join \n"
          + "		(\n"
          + "			select person_id,min(person_name_id) id \n"
          + "			from person_name\n"
          + "			where voided=0\n"
          + "			group by person_id\n"
          + "		) pn2\n"
          + "		where pn1.person_id=pn2.person_id and pn1.person_name_id=pn2.id\n"
          + "	) pn on pn.person_id=inicio.patient_id			\n"
          + "	left join\n"
          + "	(   select pid1.*\n"
          + "		from patient_identifier pid1\n"
          + "		inner join\n"
          + "		(\n"
          + "			select patient_id,min(patient_identifier_id) id\n"
          + "			from patient_identifier\n"
          + "			where voided=0\n"
          + "			group by patient_id\n"
          + "		) pid2\n"
          + "		where pid1.patient_id=pid2.patient_id and pid1.patient_identifier_id=pid2.id\n"
          + "	) pid on pid.patient_id=inicio.patient_id	\n"
          + "	left join person pr on pr.person_id=inicio.patient_id\n"
          + "	where populacao_chave.key_pop is not null or grupo_apoio.ga is not null or modelos_diferenciados.mds is not null\n"
          + ") coortes\n"
          + "group by patient_id";

  /** São pacientes elegíveis ao TPI */
  public static final String ELEGIVEIS_TPI =
      "select *\n"
          + "from\n"
          + "(\n"
          + "	select distinct pid.identifier as nid, \n"
          + "	concat(ifnull(pn.given_name,''),' ',ifnull(pn.middle_name,''),' ',ifnull(pn.family_name,'')) as nome_completo, \n"
          + "	pe.gender as genero, \n"
          + "	ROUND(datediff(:endDate,pe.birthdate)/365) as idade,\n"
          + "	pa.county_district as distrito,\n"
          + "	pa.address2 as posto_administrativo,\n"
          + "	pa.address6 as localidade,\n"
          + "	pa.address5 as bairro,\n"
          + "	pa.address1 as ponto_referencia,\n"
          + "	pat.value as contacto,\n"
          + "	confidente.telefone as telefone_confidente,\n"
          + "	inscricao.telefone as telefone_referencia,\n"
          + "	ifnull(coalesce(elegiveis_tpi.elegivel_tpi,elegiveis_tpi1.elegivel_tpi),'NAO') as elegivel_tpi,\n"
          + "	proveniencia.referencia as proveniencia,\n"
          + "	inicio.data_inicio as data_inicio_tarv,\n"
          + "	ultimo.ultimo_levantamento ultimo_lev,\n"
          + "	ultimo.value_datetime proximo_lev,\n"
          + "	seguimento.ultimo_seguimento,\n"
          + "	seguimento.value_datetime as proximo_seg\n"
          + "	from\n"
          + "	(\n"
          + "		Select 	p.patient_id,min(e.encounter_datetime) data_inicio\n"
          + "		from patient p \n"
          + "		inner join encounter e on p.patient_id=e.patient_id	\n"
          + "		inner join obs o on o.encounter_id=e.encounter_id\n"
          + "		where e.voided=0 and o.voided=0 and p.voided=0 \n"
          + "		and e.encounter_type in (18,6,9) \n"
          + "		and o.concept_id=1255 \n"
          + "		and o.value_coded=1256 \n"
          + "		and e.encounter_datetime<=:endDate \n"
          + "		and e.location_id=:location\n"
          + "		group by p.patient_id\n"
          + "\n"
          + "		union\n"
          + "\n"
          + "		Select p.patient_id,min(value_datetime) data_inicio\n"
          + "		from patient p\n"
          + "		inner join encounter e on p.patient_id=e.patient_id\n"
          + "		inner join obs o on e.encounter_id=o.encounter_id\n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "		and e.encounter_type in (18,6,9,53) \n"
          + "		and o.concept_id=1190 \n"
          + "		and o.value_datetime is not null \n"
          + "		and o.value_datetime<=:endDate \n"
          + "		and e.location_id=:location\n"
          + "		group by p.patient_id\n"
          + "\n"
          + "		union\n"
          + "\n"
          + "		select pg.patient_id,date_enrolled data_inicio\n"
          + "		from patient p inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "		where pg.voided=0 and p.voided=0 \n"
          + "		and program_id=2 \n"
          + "		and date_enrolled<=:endDate \n"
          + "		and location_id=:location\n"
          + "		\n"
          + "		union\n"
          + "		\n"
          + "		\n"
          + "		SELECT e.patient_id, MIN(e.encounter_datetime) AS data_inicio \n"
          + "		FROM patient p\n"
          + "		inner join encounter e on p.patient_id=e.patient_id\n"
          + "		WHERE p.voided=0 AND e.voided=0 \n"
          + "		and e.encounter_type in (18,52) \n"
          + "		and e.encounter_datetime<=:endDate \n"
          + "		and e.location_id=:location\n"
          + "		GROUP BY 	p.patient_id\n"
          + "	) inicio\n"
          + "	inner join\n"
          + "	(\n"
          + "		select p.patient_id,o1.value_text as telefone\n"
          + "		from patient p \n"
          + "		inner join encounter e on e.patient_id=p.patient_id\n"
          + "		left join obs o1 on o1.encounter_id=e.encounter_id and o1.concept_id=1611\n"
          + "		where e.voided=0 and p.voided=0 \n"
          + "		and e.encounter_type in (5,7) \n"
          + "		and e.encounter_datetime<=:endDate \n"
          + "		and e.location_id = :location\n"
          + "\n"
          + "		union\n"
          + "\n"
          + "		select pg.patient_id, null as telefone\n"
          + "		from patient p inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "		where pg.voided=0 and p.voided=0 \n"
          + "		and program_id=1 \n"
          + "		and date_enrolled<=:endDate \n"
          + "		and location_id=:location\n"
          + "		\n"
          + "		union\n"
          + "\n"
          + "		Select 	e.patient_id, o2.value_text as telefone\n"
          + "		from encounter e\n"
          + "		left join obs o2 on o2.encounter_id=e.encounter_id and o2.concept_id=6224\n"
          + "		where e.encounter_type = 53 \n"
          + "		and e.voided=0\n"
          + "		and e.encounter_datetime < :endDate \n"
          + "		and e.location_id=:location\n"
          + "	)inscricao on inicio.patient_id=inscricao.patient_id\n"
          + "	left join\n"
          + "	(	select max_frida.patient_id,max_frida.ultimo_levantamento,o.value_datetime\n"
          + "		from\n"
          + "		(	Select p.patient_id,max(encounter_datetime) ultimo_levantamento\n"
          + "			from patient p \n"
          + "			inner join encounter e on e.patient_id=p.patient_id\n"
          + "			where p.voided=0 and e.voided=0 \n"
          + "			and e.encounter_type = 18 \n"
          + "			and e.location_id=:location \n"
          + "			and e.encounter_datetime<=:endDate\n"
          + "			group by p.patient_id\n"
          + "		) max_frida \n"
          + "		left join obs o on o.person_id=max_frida.patient_id and max_frida.ultimo_levantamento=o.obs_datetime and o.voided=0 and o.concept_id=5096	\n"
          + "	) ultimo on inicio.patient_id=ultimo.patient_id\n"
          + "	left join\n"
          + "	(	select max_seguimento.patient_id,max_seguimento.ultimo_seguimento,o.value_datetime\n"
          + "		from\n"
          + "		(	Select p.patient_id,max(encounter_datetime) ultimo_seguimento\n"
          + "			from patient p \n"
          + "			inner join encounter e on e.patient_id=p.patient_id\n"
          + "			where p.voided=0 and e.voided=0 \n"
          + "			and e.encounter_type in (6,9) \n"
          + "			and e.location_id=:location \n"
          + "			and e.encounter_datetime<=:endDate\n"
          + "			group by p.patient_id\n"
          + "		) max_seguimento \n"
          + "		left join obs o on o.person_id=max_seguimento.patient_id and max_seguimento.ultimo_seguimento=o.obs_datetime and o.voided=0 and o.concept_id=1410		\n"
          + "	) seguimento on inicio.patient_id=seguimento.patient_id\n"
          + "	inner join person pe on pe.person_id=inicio.patient_id				\n"
          + "	left join 			\n"
          + "	(	select pn1.*\n"
          + "		from person_name pn1\n"
          + "		inner join \n"
          + "		(\n"
          + "			select person_id,min(person_name_id) id \n"
          + "			from person_name\n"
          + "			where voided=0\n"
          + "			group by person_id\n"
          + "		) pn2\n"
          + "		where pn1.person_id=pn2.person_id and pn1.person_name_id=pn2.id\n"
          + "	) pn on pn.person_id=inicio.patient_id			\n"
          + "	left join\n"
          + "	(   select pid1.*\n"
          + "		from patient_identifier pid1\n"
          + "		inner join\n"
          + "		(\n"
          + "			select patient_id,min(patient_identifier_id) id\n"
          + "			from patient_identifier\n"
          + "			where voided=0\n"
          + "			group by patient_id\n"
          + "		) pid2\n"
          + "		where pid1.patient_id=pid2.patient_id and pid1.patient_identifier_id=pid2.id\n"
          + "	) pid on pid.patient_id=inicio.patient_id\n"
          + "	left join person_address pa on pa.person_id=pe.person_id\n"
          + "	left join person_attribute pat on pat.person_id=pe.person_id and pat.person_attribute_type_id=9\n"
          + "	left join\n"
          + "	(\n"
          + "		select p.patient_id, o.value_text as telefone\n"
          + "		from patient p\n"
          + "		inner join encounter e on e.patient_id=p.patient_id\n"
          + "		inner join obs o on o.encounter_id=e.encounter_id \n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0\n"
          + "		and e.encounter_type=34\n"
          + "		and o.concept_id=1611\n"
          + "		and e.location_id=:location\n"
          + "\n"
          + "		union\n"
          + "		\n"
          + "		select p.patient_id, o.value_text as telefone\n"
          + "		from patient p\n"
          + "		inner join encounter e on e.patient_id=p.patient_id\n"
          + "		inner join obs o on o.encounter_id=e.encounter_id \n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0\n"
          + "		and e.encounter_type=53\n"
          + "		and o.concept_id=6224\n"
          + "		and e.location_id=:location\n"
          + "	) confidente on inicio.patient_id=confidente.patient_id\n"
          + "	left join\n"
          + "	(\n"
          + "		select patient_id, referencia, max(date_created), data_inicio_programa\n"
          + "		from(\n"
          + "			select p.patient_id, pr.name referencia, max(pp.date_enrolled) as data_inicio_programa, pp.date_created\n"
          + "			from patient p\n"
          + "			inner join patient_program pp on pp.patient_id=p.patient_id\n"
          + "			inner join program pr on pr.program_id=pp.program_id\n"
          + "			where pp.date_enrolled < :endDate\n"
          + "			and pp.date_completed is null\n"
          + "			and pp.location_id=:location\n"
          + "			and p.voided=0 and pp.voided=0\n"
          + "			group by patient_id,pr.name\n"
          + "		) a group by patient_id\n"
          + "	) proveniencia on proveniencia.patient_id=inicio.patient_id\n"
          + "	left join\n"
          + "	(\n"
          + "		select patient_id, \"SIM\" as elegivel_tpi\n"
          + "		from patient p1\n"
          + "		where patient_id not in\n"
          + "		(	\n"
          + "			-- Pacientes que iniciaram tratamento de TB e não terminaram\n"
          + "			select inicio_tb.patient_id\n"
          + "			from\n"
          + "			(	Select p.patient_id,max(o.value_datetime) data_inicio_tb\n"
          + "				from patient p \n"
          + "				inner join encounter e on e.patient_id=p.patient_id\n"
          + "				inner join obs o on o.encounter_id=e.encounter_id\n"
          + "				where p.voided=0 and o.voided=0 and e.voided=0\n"
          + "				and o.concept_id=1113\n"
          + "				and o.value_datetime <= :endDate\n"
          + "				and e.location_id=:location \n"
          + "				and e.encounter_type in (6,9,25,20) \n"
          + "				group by patient_id\n"
          + "\n"
          + "				union\n"
          + "\n"
          + "				select pg.patient_id,max(date_enrolled) data_inicio_tb\n"
          + "				from patient p inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "				where pg.voided=0 and p.voided=0 \n"
          + "				and program_id=5 \n"
          + "				and date_enrolled <= :endDate\n"
          + "				and location_id=:location\n"
          + "				group by patient_id\n"
          + "\n"
          + "				union\n"
          + "\n"
          + "				Select p.patient_id,max(o.obs_datetime) data_inicio_tb\n"
          + "				from patient p \n"
          + "				inner join encounter e on e.patient_id=p.patient_id\n"
          + "				inner join obs o on o.encounter_id=e.encounter_id\n"
          + "				where p.voided=0 and o.voided=0 and e.voided=0\n"
          + "				and o.concept_id=1268\n"
          + "				and o.value_coded=1256 \n"
          + "				and o.obs_datetime <= :endDate\n"
          + "				and e.location_id=:location \n"
          + "				and e.encounter_type in (6,9) \n"
          + "				group by patient_id\n"
          + "			) inicio_tb\n"
          + "			where inicio_tb.patient_id not in\n"
          + "			(\n"
          + "				select fim_tb.patient_id\n"
          + "				from\n"
          + "				(	Select p.patient_id,max(o.value_datetime) data_fim_tb\n"
          + "					from patient p \n"
          + "					inner join encounter e on e.patient_id=p.patient_id\n"
          + "					inner join obs o on o.encounter_id=e.encounter_id\n"
          + "					where p.voided=0 and e.voided=0 and o.voided=0\n"
          + "					and o.concept_id=6120\n"
          + "					and o.value_datetime <= :endDate\n"
          + "					and e.location_id=:location \n"
          + "					and e.encounter_type in (6,9,25,20) \n"
          + "					group by patient_id\n"
          + "				\n"
          + "					union\n"
          + "				\n"
          + "					select pg.patient_id,max(date_completed) data_fim_tb\n"
          + "					from patient p inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "					where pg.voided=0 and p.voided=0 \n"
          + "					and program_id=5 \n"
          + "					and date_enrolled is not null \n"
          + "					and date_completed is not null \n"
          + "					and date_completed <= :endDate\n"
          + "					and location_id=:location\n"
          + "					group by patient_id\n"
          + "\n"
          + "					union\n"
          + "	\n"
          + "					Select p.patient_id,max(o.obs_datetime) data_inicio_tb\n"
          + "					from patient p \n"
          + "					inner join encounter e on e.patient_id=p.patient_id\n"
          + "					inner join obs o on o.encounter_id=e.encounter_id\n"
          + "					where p.voided=0 and o.voided=0 and e.voided=0\n"
          + "					and o.concept_id=1268\n"
          + "					and o.value_coded=1267 \n"
          + "					and o.obs_datetime <= :endDate\n"
          + "					and e.location_id=:location \n"
          + "					and e.encounter_type in (6,9) \n"
          + "					group by patient_id\n"
          + "				) fim_tb\n"
          + "				where inicio_tb.data_inicio_tb < fim_tb.data_fim_tb\n"
          + "			)\n"
          + "		)\n"
          + "	) elegiveis_tpi on inicio.patient_id=elegiveis_tpi.patient_id and inicio.data_inicio>=:startDate \n"
          + "	left join \n"
          + "	(\n"
          + "		select patient_id, \"SIM\" as elegivel_tpi\n"
          + "		from patient p1\n"
          + "		where patient_id in\n"
          + "		(\n"
          + "			-- PACIENTES EXPOSTOS A TB\n"
          + "			select distinct p.person_id\n"
          + "			from person p\n"
          + "			inner join encounter e on e.patient_id=p.person_id\n"
          + "			inner join obs o on o.person_id=p.person_id\n"
          + "			where p.voided=0 and e.voided=0 and o.voided=0\n"
          + "			and e.encounter_type in (6,9)\n"
          + "			and o.concept_id=1649\n"
          + "			and o.value_text='Exposto a TB' \n"
          + "			and o.location_id=:location\n"
          + "			and e.encounter_datetime between :startDate and :endDate		\n"
          + "		)\n"
          + "	) elegiveis_tpi1 on inicio.patient_id=elegiveis_tpi1.patient_id and (datediff(:endDate,pe.birthdate)<365 or inicio.data_inicio<:startDate)\n"
          + "	where inicio.patient_id not in\n"
          + "	(\n"
          + "		-- Pacientes que sairam do programa de tratamento\n"
          + "		select p.patient_id\n"
          + "		from patient p \n"
          + "		inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "		inner join patient_state ps on pg.patient_program_id=ps.patient_program_id\n"
          + "		where pg.program_id=2 -- SERVICO TARV - TRATAMENTO\n"
          + "		and ps.state in (7,8,9,10) -- TRANSFERIDO PARA, SUSPENDER TRATAMENTO, ABANDONO, OBITOU\n"
          + "		and ps.end_date is null\n"
          + "		and pg.voided=0 and ps.voided=0 and p.voided=0 \n"
          + "		and ps.start_date<= :endDate\n"
          + "		and location_id=:location\n"
          + "	\n"
          + "		union all\n"
          + "		\n"
          + "		-- Abandono não notificado\n"
          + "		select ultimo_fila.patient_id\n"
          + "		from\n"
          + "		(	select p.patient_id,max(encounter_datetime) encounter_datetime\n"
          + "			from patient p \n"
          + "			inner join encounter e on e.patient_id=p.patient_id\n"
          + "			where p.voided=0 and e.voided=0\n"
          + "			and e.encounter_type=18 \n"
          + "			and e.location_id=:location \n"
          + "			and e.encounter_datetime<=:endDate\n"
          + "			group by p.patient_id\n"
          + "		) ultimo_fila\n"
          + "		inner join obs o on o.person_id=ultimo_fila.patient_id\n"
          + "		where o.voided=0 \n"
          + "		and ultimo_fila.encounter_datetime=o.obs_datetime \n"
          + "		and o.concept_id=5096 -- \n"
          + "		and o.location_id=:location\n"
          + "		and ultimo_fila.patient_id not in 	\n"
          + "		(	select p.patient_id\n"
          + "			from patient p \n"
          + "			inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "			inner join patient_state ps on pg.patient_program_id=ps.patient_program_id\n"
          + "			where pg.voided=0 and ps.voided=0 and p.voided=0 \n"
          + "			and pg.program_id=2 \n"
          + "			and ps.state in (7,8,9,10) \n"
          + "			and ps.end_date is null\n"
          + "			and ps.start_date<= :endDate\n"
          + "			and location_id=:location\n"
          + "		)\n"
          + "		and ultimo_fila.patient_id not in\n"
          + "		(	select patient_id\n"
          + "			from\n"
          + "			(	select p.patient_id,max(encounter_datetime) encounter_datetime\n"
          + "				from patient p \n"
          + "				inner join encounter e on e.patient_id=p.patient_id\n"
          + "				where p.voided=0 and e.voided=0 \n"
          + "				and e.encounter_type in (6,9) \n"
          + "				and e.location_id=:location \n"
          + "				and e.encounter_datetime<= :endDate\n"
          + "				group by p.patient_id\n"
          + "			) ultimo_seguimento\n"
          + "			inner join obs o on o.person_id=ultimo_seguimento.patient_id\n"
          + "			where ultimo_seguimento.encounter_datetime=o.obs_datetime \n"
          + "			and o.voided=0 \n"
          + "			and o.concept_id=1410 -- DATA DE PROXIMA CONSULTA\n"
          + "			and o.location_id=:location \n"
          + "			and datediff(:endDate,o.value_datetime)<60\n"
          + "				\n"
          + "		)\n"
          + "		and ultimo_fila.patient_id not in\n"
          + "		(	select abandono.patient_id\n"
          + "			from \n"
          + "			(	select p.patient_id, ps.start_date\n"
          + "				from patient p \n"
          + "				inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "				inner join patient_state ps on pg.patient_program_id=ps.patient_program_id\n"
          + "				where pg.voided=0 and ps.voided=0 and p.voided=0 \n"
          + "				and pg.program_id=2 \n"
          + "				and ps.state=9 and ps.end_date is null \n"
          + "				and ps.start_date<=:endDate \n"
          + "				and location_id=:location\n"
          + "			)abandono\n"
          + "			inner join 	\n"
          + "			(	select max_fila.patient_id,max_fila.encounter_datetime,o.value_datetime\n"
          + "				from\n"
          + "				(	Select p.patient_id,max(encounter_datetime) encounter_datetime\n"
          + "					from patient p \n"
          + "					inner join encounter e on e.patient_id=p.patient_id\n"
          + "					where p.voided=0 and e.voided=0 and e.encounter_type=18 \n"
          + "					and e.location_id=:location \n"
          + "					and e.encounter_datetime<=:endDate\n"
          + "					group by p.patient_id\n"
          + "				) max_fila \n"
          + "				inner join obs o on o.person_id=max_fila.patient_id\n"
          + "				where max_fila.encounter_datetime=o.obs_datetime \n"
          + "				and o.voided=0 \n"
          + "				and o.concept_id=5096 \n"
          + "				and o.location_id=:location\n"
          + "			) ultimo_fila1 on abandono.patient_id=ultimo_fila1.patient_id\n"
          + "			where datediff(:endDate,ultimo_fila1.value_datetime)<60\n"
          + "		)\n"
          + "		and datediff(:endDate,o.value_datetime)>=60\n"
          + "	)\n"
          + "	group by pid.identifier\n"
          + ") elegiveis\n"
          + "where elegivel_tpi='SIM'";

  public static final String PACIENTES_DEVIAM_TERMINAR_TPI =
      "select distinct pi.identifier as nid, \n"
          + "concat(ifnull(pn.given_name,''),' ',ifnull(pn.middle_name,''),' ',ifnull(pn.family_name,'')) as nome_completo, \n"
          + "pe.gender as genero, \n"
          + "ROUND(datediff(:endDate,pe.birthdate)/365) as idade,\n"
          + "pa.county_district as distrito,\n"
          + "pa.address2 as posto_administrativo,\n"
          + "pa.address6 as localidade,\n"
          + "pa.address5 as bairro,\n"
          + "pat.value as contacto, \n"
          + "pa.address1 as ponto_referencia, \n"
          + "inicio.data_inicio as data_inicio_tarv,\n"
          + "seguimento.ultimo_seguimento,\n"
          + "seguimento.value_datetime as proximo_seg,\n"
          + "proveniencia.referencia as proveniencia,\n"
          + "ultimo.ultimo_levantamento ultimo_lev,\n"
          + "ultimo.value_datetime proximo_lev,\n"
          + "inicio_tpi.data_inicio_tpi as data_inicio_tpi,\n"
          + "fim_tpi.data_fim_tpi as data_termino_tpi\n"
          + "from(\n"
          + "	select inicio_real.patient_id, min(data_inicio) as data_inicio\n"
          + "	from(\n"
          + "		-- Gestão TARV: Início, Transferido De\n"
          + "		select p.patient_id, min(e.encounter_datetime) as data_inicio\n"
          + "		from patient p\n"
          + "		inner join encounter e on e.patient_id=p.patient_id\n"
          + "		inner join obs o on e.patient_id=o.person_id and e.encounter_datetime=o.obs_datetime\n"
          + "		where o.concept_id=1255 -- GESTÃO TARV\n"
          + "		and o.value_coded in (1256,1369) -- INICIO, TRANSFERIDO DE\n"
          + "		and e.encounter_type in (6,9,18) -- S.TARV: ADULTO SEGUIMENTO, S.TARV: PEDIATRIA SEGUIMENTO, S.TARV: FARMACIA \n"
          + "		and e.encounter_datetime < date_add(:endDate, interval -6 MONTH)\n"
          + "		and e.location_id=:location\n"
          + "		and e.voided=0 and o.voided=0 and p.voided=0\n"
          + "		group by p.patient_id\n"
          + "		\n"
          + "		union all\n"
          + "		\n"
          + "		-- Inscrição no programa de tratamento\n"
          + "		select p.patient_id, pp.date_enrolled as data_inicio\n"
          + "		from patient p\n"
          + "		inner join patient_program pp on pp.patient_id=p.patient_id\n"
          + "		where pp.program_id=2 -- SERVICO TARV - TRATAMENTO\n"
          + "		and pp.date_enrolled < date_add(:endDate, interval -6 MONTH)\n"
          + "		and pp.location_id=:location\n"
          + "		and p.voided=0 and pp.voided=0\n"
          + "		\n"
          + "		union all\n"
          + "		\n"
          + "		-- Data inicio tarv\n"
          + "		select p.patient_id, min(o.value_datetime) as data_inicio\n"
          + "		from patient p\n"
          + "		inner join encounter e on e.patient_id=p.patient_id\n"
          + "		inner join obs o on o.person_id=p.patient_id and e.encounter_datetime=o.obs_datetime\n"
          + "		where e.encounter_type in (6,9,18,53) -- S.TARV: ADULTO SEGUIMENTO, S.TARV: PEDIATRIA SEGUIMENTO, S.TARV: FARMACIA\n"
          + "		and o.concept_id=1190 -- DATA DE INICIO DO TARV\n"
          + "		and o.value_datetime is not null\n"
          + "		and o.value_datetime <= date_add(:endDate, interval -6 MONTH)\n"
          + "		and e.location_id=:location\n"
          + "		and p.voided=0 and e.voided=0 and o.voided=0\n"
          + "		group by p.patient_id\n"
          + "		\n"
          + "		union all\n"
          + "		\n"
          + "		--  Primeiro levantamento de ARV\n"
          + "		select p.patient_id, min(e.encounter_datetime) as data_inicio\n"
          + "		from patient p\n"
          + "		inner join encounter e on e.patient_id=p.patient_id\n"
          + "		where e.encounter_type in (18,52)  -- S.TARV: FARMACIA\n"
          + "		and e.encounter_datetime <= date_add(:endDate, interval -6 MONTH)\n"
          + "		and e.location_id=:location\n"
          + "		and p.voided=0 and e.voided=0\n"
          + "		group by p.patient_id\n"
          + "	) inicio_real\n"
          + "	group by inicio_real.patient_id\n"
          + ") inicio\n"
          + "left join\n"
          + "(	select max_frida.patient_id,max_frida.ultimo_levantamento,o.value_datetime\n"
          + "	from\n"
          + "	(	Select p.patient_id,max(encounter_datetime) ultimo_levantamento\n"
          + "		from patient p \n"
          + "		inner join encounter e on e.patient_id=p.patient_id\n"
          + "		where p.voided=0 and e.voided=0 \n"
          + "		and e.encounter_type = 18 \n"
          + "		and e.location_id=:location\n"
          + "		and e.encounter_datetime<=:endDate\n"
          + "		group by p.patient_id\n"
          + "	) max_frida \n"
          + "	left join obs o on o.person_id=max_frida.patient_id and max_frida.ultimo_levantamento=o.obs_datetime and o.voided=0 and o.concept_id=5096\n"
          + ") ultimo on inicio.patient_id=ultimo.patient_id\n"
          + "left join\n"
          + "(	select max_seguimento.patient_id,max_seguimento.ultimo_seguimento,o.value_datetime\n"
          + "	from\n"
          + "	(	Select p.patient_id,max(encounter_datetime) ultimo_seguimento\n"
          + "		from patient p \n"
          + "		inner join encounter e on e.patient_id=p.patient_id\n"
          + "		where p.voided=0 and e.voided=0 \n"
          + "		and e.encounter_type in (6,9) \n"
          + "		and e.location_id=:location \n"
          + "		and e.encounter_datetime<=:endDate\n"
          + "		group by p.patient_id\n"
          + "	) max_seguimento \n"
          + "	left join obs o on o.person_id=max_seguimento.patient_id and max_seguimento.ultimo_seguimento=o.obs_datetime and o.voided=0 and o.concept_id=1410		\n"
          + ") seguimento on inicio.patient_id=seguimento.patient_id\n"
          + "left join\n"
          + "(\n"
          + "	select patient_id, referencia, max(date_created), data_inicio_programa\n"
          + "	from(\n"
          + "		select p.patient_id, pr.name referencia, max(pp.date_enrolled) as data_inicio_programa, pp.date_created\n"
          + "		from patient p\n"
          + "		inner join patient_program pp on pp.patient_id=p.patient_id\n"
          + "		inner join program pr on pr.program_id=pp.program_id\n"
          + "		where pp.date_enrolled < :endDate\n"
          + "		and pp.date_completed is null\n"
          + "		and pp.location_id=:location\n"
          + "		and p.voided=0 and pp.voided=0\n"
          + "		group by patient_id,pr.name\n"
          + "	) a group by patient_id\n"
          + ") proveniencia on proveniencia.patient_id=inicio.patient_id\n"
          + "inner join person pe on pe.person_id=inicio.patient_id\n"
          + "inner join patient_identifier pi on pi.patient_id=pe.person_id and pi.identifier_type=2\n"
          + "inner join person_name pn on pn.person_id=pe.person_id\n"
          + "left join person_address pa on pa.person_id=pe.person_id\n"
          + "left join person_attribute pat on pat.person_id=pe.person_id and pat.person_attribute_type_id=9\n"
          + "inner join\n"
          + "(\n"
          + "	-- PACIENTES QUE INICIARAM TPI\n"
          + "	select p.patient_id, max(o.value_datetime) as data_inicio_tpi\n"
          + "	from	patient p\n"
          + "	inner join encounter e on p.patient_id=e.patient_id\n"
          + "	inner join obs o on o.encounter_id=e.encounter_id\n"
          + "	where e.voided=0 and p.voided=0 and o.voided=0\n"
          + "	and o.value_datetime between date_add(:startDate, interval -6 MONTH) and date_add(:endDate, interval -6 MONTH) \n"
          + "	and o.concept_id=6128 -- DATA DE INICIO DA PROFILAXIA COM ISONIAZIDA\n"
          + "	and e.encounter_type in (6,9,53) -- S.TARV: ADULTO SEGUIMENTO, S.TARV: PEDIATRIA SEGUIMENTO\n"
          + "	and e.location_id=:location\n"
          + "	group by p.patient_id\n"
          + "\n"
          + "	union\n"
          + "\n"
          + "	select e.patient_id, max(e.encounter_datetime) data_inicio_tpi\n"
          + "	from patient p\n"
          + "	inner join encounter e on e.patient_id=p.patient_id\n"
          + "	inner join obs o on o.encounter_id=e.encounter_id\n"
          + "	where e.voided=0 and p.voided=0 and o.voided=0\n"
          + "	and e.encounter_datetime between date_add(:startDate, interval -6 MONTH) and date_add(:endDate, interval -6 MONTH) \n"
          + "	and e.voided=0 and p.voided=0 and o.voided=0 \n"
          + "	and e.location_id=:location \n"
          + "	and e.encounter_type in (6,9) \n"
          + "	and o.concept_id=6122 \n"
          + "	and o.value_coded=1256\n"
          + "	group by e.patient_id\n"
          + ") inicio_tpi on inicio.patient_id=inicio_tpi.patient_id\n"
          + "left join\n"
          + "(\n"
          + "	-- PACIENTES QUE TERMINARAM TPI\n"
          + "	select p.patient_id, o.value_datetime as data_fim_tpi\n"
          + "	from	patient p\n"
          + "	inner join encounter e on p.patient_id=e.patient_id\n"
          + "	inner join obs o on o.encounter_id=e.encounter_id\n"
          + "	where e.voided=0 and p.voided=0 and o.voided=0\n"
          + "	and o.value_datetime >= :startDate\n"
          + "	and o.concept_id=6129 -- DATA DE FIM DA PROFILAXIA COM ISONIAZIDA\n"
          + "	and e.encounter_type in (6,9,53) -- S.TARV: ADULTO SEGUIMENTO, S.TARV: PEDIATRIA SEGUIMENTO \n"
          + "	and e.location_id=:location\n"
          + "\n"
          + "	union\n"
          + "\n"
          + "	select e.patient_id, max(e.encounter_datetime) data_fim_tpi\n"
          + "	from patient p\n"
          + "	inner join encounter e on e.patient_id=p.patient_id\n"
          + "	inner join obs o on o.encounter_id=e.encounter_id\n"
          + "	where e.encounter_datetime >= :startDate \n"
          + "	and e.voided=0 and p.voided=0 and o.voided=0 \n"
          + "	and e.location_id=:location \n"
          + "	and e.encounter_type in (6,9) \n"
          + "	and o.concept_id=6122 \n"
          + "	and o.value_coded=1267\n"
          + "	group by e.patient_id\n"
          + ") fim_tpi on inicio_tpi.patient_id=fim_tpi.patient_id\n"
          + "where inicio.patient_id not in\n"
          + "(\n"
          + "	-- Pacientes que sairam do programa de tratamento\n"
          + "	select p.patient_id\n"
          + "	from patient p \n"
          + "	inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "	inner join patient_state ps on pg.patient_program_id=ps.patient_program_id\n"
          + "	where pg.program_id=2 -- SERVICO TARV - TRATAMENTO\n"
          + "	and ps.state in (7,8,9,10) -- TRANSFERIDO PARA, SUSPENDER TRATAMENTO, ABANDONO, OBITOU\n"
          + "	and ps.end_date is null\n"
          + "	and pg.voided=0 and ps.voided=0 and p.voided=0 \n"
          + "	and ps.start_date<= :endDate\n"
          + "	and location_id=:location\n"
          + "\n"
          + "	union all\n"
          + "	\n"
          + "	-- Abandono não notificado\n"
          + "	select ultimo_fila.patient_id\n"
          + "	from\n"
          + "	(	select p.patient_id,max(encounter_datetime) encounter_datetime\n"
          + "		from patient p \n"
          + "		inner join encounter e on e.patient_id=p.patient_id\n"
          + "		where p.voided=0 and e.voided=0\n"
          + "		and e.encounter_type=18 \n"
          + "		and e.location_id=:location \n"
          + "		and e.encounter_datetime<=:endDate\n"
          + "		group by p.patient_id\n"
          + "	) ultimo_fila\n"
          + "	inner join obs o on o.person_id=ultimo_fila.patient_id\n"
          + "	where o.voided=0 \n"
          + "	and ultimo_fila.encounter_datetime=o.obs_datetime \n"
          + "	and o.concept_id=5096 -- \n"
          + "	and o.location_id=:location\n"
          + "	and ultimo_fila.patient_id not in 	\n"
          + "	(	select p.patient_id\n"
          + "		from patient p \n"
          + "		inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "		inner join patient_state ps on pg.patient_program_id=ps.patient_program_id\n"
          + "		where pg.voided=0 and ps.voided=0 and p.voided=0 \n"
          + "		and pg.program_id=2 \n"
          + "		and ps.state in (7,8,9,10) \n"
          + "		and ps.end_date is null\n"
          + "		and ps.start_date<= :endDate\n"
          + "		and location_id=:location\n"
          + "	)\n"
          + "	and ultimo_fila.patient_id not in\n"
          + "	(	select patient_id\n"
          + "		from\n"
          + "		(	select p.patient_id,max(encounter_datetime) encounter_datetime\n"
          + "			from patient p \n"
          + "			inner join encounter e on e.patient_id=p.patient_id\n"
          + "			where p.voided=0 and e.voided=0 \n"
          + "			and e.encounter_type in (6,9) \n"
          + "			and e.location_id=:location \n"
          + "			and e.encounter_datetime<= :endDate\n"
          + "			group by p.patient_id\n"
          + "		) ultimo_seguimento\n"
          + "		inner join obs o on o.person_id=ultimo_seguimento.patient_id\n"
          + "		where ultimo_seguimento.encounter_datetime=o.obs_datetime \n"
          + "		and o.voided=0 \n"
          + "		and o.concept_id=1410 -- DATA DE PROXIMA CONSULTA\n"
          + "		and o.location_id=:location \n"
          + "		and datediff(:endDate,o.value_datetime)<60\n"
          + "			\n"
          + "	)\n"
          + "	and ultimo_fila.patient_id not in\n"
          + "	(	select abandono.patient_id\n"
          + "		from \n"
          + "		(	select p.patient_id, ps.start_date\n"
          + "			from patient p \n"
          + "			inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "			inner join patient_state ps on pg.patient_program_id=ps.patient_program_id\n"
          + "			where pg.voided=0 and ps.voided=0 and p.voided=0 \n"
          + "			and pg.program_id=2 \n"
          + "			and ps.state=9 and ps.end_date is null \n"
          + "			and ps.start_date<=:endDate \n"
          + "			and location_id=:location\n"
          + "		)abandono\n"
          + "		inner join 	\n"
          + "		(	select max_fila.patient_id,max_fila.encounter_datetime,o.value_datetime\n"
          + "			from\n"
          + "			(	Select p.patient_id,max(encounter_datetime) encounter_datetime\n"
          + "				from patient p \n"
          + "				inner join encounter e on e.patient_id=p.patient_id\n"
          + "				where p.voided=0 and e.voided=0 and e.encounter_type=18 \n"
          + "				and e.location_id=:location \n"
          + "				and e.encounter_datetime<=:endDate\n"
          + "				group by p.patient_id\n"
          + "			) max_fila \n"
          + "			inner join obs o on o.person_id=max_fila.patient_id\n"
          + "			where max_fila.encounter_datetime=o.obs_datetime \n"
          + "			and o.voided=0 \n"
          + "			and o.concept_id=5096 \n"
          + "			and o.location_id=:location\n"
          + "		) ultimo_fila1 on abandono.patient_id=ultimo_fila1.patient_id\n"
          + "		where datediff(:endDate,ultimo_fila1.value_datetime)<60\n"
          + "	)\n"
          + "	and datediff(:endDate,o.value_datetime)>=60\n"
          + ")\n"
          + "group by pi.identifier";

  /** São pacientes elegíveis a Carga Viral */
  public static final String ELEGIVEIS_CARGA_VIRAL =
      "select *\n"
          + "from\n"
          + "(\n"
          + "	select distinct pid.identifier as nid, \n"
          + "	concat(ifnull(pn.given_name,''),' ',ifnull(pn.middle_name,''),' ',ifnull(pn.family_name,'')) as nome_completo, \n"
          + "	pe.gender as genero, \n"
          + "	ROUND(datediff(:endDate,pe.birthdate)/365) as idade,\n"
          + "	pa.county_district as distrito,\n"
          + "	pa.address2 as posto_administrativo,\n"
          + "	pa.address6 as localidade,\n"
          + "	pa.address5 as bairro,\n"
          + "	pa.address1 as ponto_referencia,\n"
          + "	pat.value as contacto,\n"
          + "	confidente.telefone as telefone_confidente,\n"
          + "	inscricao.telefone as telefone_referencia, \n"
          + "	ifnull(elegiveis_cv.elegivel_cv,'NAO') as elegivel_cv,\n"
          + "	proveniencia.referencia as proveniencia,\n"
          + "	inicio.data_inicio as data_inicio_tarv,\n"
          + "	ultimo.ultimo_levantamento ultimo_lev,\n"
          + "	ultimo.value_datetime proximo_lev,\n"
          + "	seguimento.ultimo_seguimento,\n"
          + "	seguimento.value_datetime as proximo_seg,\n"
          + "	elegiveis_cv.ultima_cv as ultima_cv,\n"
          + "	elegiveis_cv.data_ultima_cv\n"
          + "	from\n"
          + "	(\n"
          + "		Select 	p.patient_id,min(e.encounter_datetime) data_inicio\n"
          + "		from patient p \n"
          + "		inner join encounter e on p.patient_id=e.patient_id	\n"
          + "		inner join obs o on o.encounter_id=e.encounter_id\n"
          + "		where e.voided=0 and o.voided=0 and p.voided=0 \n"
          + "		and e.encounter_type in (18,6,9) \n"
          + "		and o.concept_id=1255 \n"
          + "		and o.value_coded=1256 \n"
          + "		and e.encounter_datetime<=:endDate \n"
          + "		and e.location_id=:location\n"
          + "		group by p.patient_id\n"
          + "\n"
          + "		union\n"
          + "\n"
          + "		Select p.patient_id,min(value_datetime) data_inicio\n"
          + "		from patient p\n"
          + "		inner join encounter e on p.patient_id=e.patient_id\n"
          + "		inner join obs o on e.encounter_id=o.encounter_id\n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "		and e.encounter_type in (18,6,9,53) \n"
          + "		and o.concept_id=1190 \n"
          + "		and o.value_datetime is not null \n"
          + "		and o.value_datetime<=:endDate \n"
          + "		and e.location_id=:location\n"
          + "		group by p.patient_id\n"
          + "\n"
          + "		union\n"
          + "\n"
          + "		select pg.patient_id,date_enrolled data_inicio\n"
          + "		from patient p inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "		where pg.voided=0 and p.voided=0 \n"
          + "		and program_id=2 \n"
          + "		and date_enrolled<=:endDate \n"
          + "		and location_id=:location\n"
          + "		\n"
          + "		union\n"
          + "		\n"
          + "		select e.patient_id, MIN(e.encounter_datetime) AS data_inicio \n"
          + "		from patient p\n"
          + "		inner join encounter e on p.patient_id=e.patient_id\n"
          + "		where p.voided=0 AND e.voided=0 \n"
          + "		and e.encounter_type in (18,52) \n"
          + "		and e.encounter_datetime<=:endDate \n"
          + "		and e.location_id=:location\n"
          + "		group by p.patient_id\n"
          + "	) inicio\n"
          + "	inner join\n"
          + "	(\n"
          + "		select p.patient_id,o1.value_text as telefone\n"
          + "		from patient p \n"
          + "		inner join encounter e on e.patient_id=p.patient_id\n"
          + "		left join obs o1 on o1.encounter_id=e.encounter_id and o1.concept_id=1611\n"
          + "		where e.voided=0 and p.voided=0 \n"
          + "		and e.encounter_type in (5,7) \n"
          + "		and e.encounter_datetime<=:endDate \n"
          + "		and e.location_id = :location\n"
          + "\n"
          + "		union\n"
          + "\n"
          + "		select pg.patient_id, null as telefone\n"
          + "		from patient p inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "		where pg.voided=0 and p.voided=0 \n"
          + "		and program_id=1 \n"
          + "		and date_enrolled<=:endDate \n"
          + "		and location_id=:location\n"
          + "		\n"
          + "		union\n"
          + "\n"
          + "		Select 	e.patient_id, o2.value_text as telefone\n"
          + "		from encounter e\n"
          + "		left join obs o2 on o2.encounter_id=e.encounter_id and o2.concept_id=6224\n"
          + "		where e.encounter_type = 53 \n"
          + "		and e.voided=0\n"
          + "		and e.encounter_datetime < :endDate \n"
          + "		and e.location_id=:location\n"
          + "	)inscricao on inicio.patient_id=inscricao.patient_id\n"
          + "	left join\n"
          + "	(	select max_frida.patient_id,max_frida.ultimo_levantamento,o.value_datetime\n"
          + "		from\n"
          + "		(	Select p.patient_id,max(encounter_datetime) ultimo_levantamento\n"
          + "			from patient p \n"
          + "			inner join encounter e on e.patient_id=p.patient_id\n"
          + "			where p.voided=0 and e.voided=0 \n"
          + "			and e.encounter_type = 18 \n"
          + "			and e.location_id=:location \n"
          + "			and e.encounter_datetime<=:endDate\n"
          + "			group by p.patient_id\n"
          + "		) max_frida \n"
          + "		left join obs o on o.person_id=max_frida.patient_id and max_frida.ultimo_levantamento=o.obs_datetime and o.voided=0 and o.concept_id=5096	\n"
          + "	) ultimo on inicio.patient_id=ultimo.patient_id\n"
          + "	left join\n"
          + "	(	select max_seguimento.patient_id,max_seguimento.ultimo_seguimento,o.value_datetime\n"
          + "		from\n"
          + "		(	Select p.patient_id,max(encounter_datetime) ultimo_seguimento\n"
          + "			from patient p \n"
          + "			inner join encounter e on e.patient_id=p.patient_id\n"
          + "			where p.voided=0 and e.voided=0 \n"
          + "			and e.encounter_type in (6,9) \n"
          + "			and e.location_id=:location \n"
          + "			and e.encounter_datetime<=:endDate\n"
          + "			group by p.patient_id\n"
          + "		) max_seguimento \n"
          + "		left join obs o on o.person_id=max_seguimento.patient_id and max_seguimento.ultimo_seguimento=o.obs_datetime and o.voided=0 and o.concept_id=1410		\n"
          + "	) seguimento on inicio.patient_id=seguimento.patient_id\n"
          + "	inner join person pe on pe.person_id=inicio.patient_id				\n"
          + "	left join 			\n"
          + "	(	select pn1.*\n"
          + "		from person_name pn1\n"
          + "		inner join \n"
          + "		(\n"
          + "			select person_id,min(person_name_id) id \n"
          + "			from person_name\n"
          + "			where voided=0\n"
          + "			group by person_id\n"
          + "		) pn2\n"
          + "		where pn1.person_id=pn2.person_id and pn1.person_name_id=pn2.id\n"
          + "	) pn on pn.person_id=inicio.patient_id			\n"
          + "	left join\n"
          + "	(   select pid1.*\n"
          + "		from patient_identifier pid1\n"
          + "		inner join\n"
          + "		(\n"
          + "			select patient_id,min(patient_identifier_id) id\n"
          + "			from patient_identifier\n"
          + "			where voided=0\n"
          + "			group by patient_id\n"
          + "		) pid2\n"
          + "		where pid1.patient_id=pid2.patient_id and pid1.patient_identifier_id=pid2.id\n"
          + "	) pid on pid.patient_id=inicio.patient_id\n"
          + "	left join person_address pa on pa.person_id=pe.person_id\n"
          + "	left join person_attribute pat on pat.person_id=pe.person_id and pat.person_attribute_type_id=9\n"
          + "	left join\n"
          + "	(\n"
          + "		select p.patient_id, o.value_text as telefone\n"
          + "		from patient p\n"
          + "		inner join encounter e on e.patient_id=p.patient_id\n"
          + "		inner join obs o on o.encounter_id=e.encounter_id \n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0\n"
          + "		and e.encounter_type=34\n"
          + "		and o.concept_id=1611\n"
          + "		and e.location_id=:location\n"
          + "\n"
          + "		union\n"
          + "		\n"
          + "		select p.patient_id, o.value_text as telefone\n"
          + "		from patient p\n"
          + "		inner join encounter e on e.patient_id=p.patient_id\n"
          + "		inner join obs o on o.encounter_id=e.encounter_id \n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0\n"
          + "		and e.encounter_type=53\n"
          + "		and o.concept_id=6224\n"
          + "		and e.location_id=:location\n"
          + "	) confidente on inicio.patient_id=confidente.patient_id\n"
          + "	left join\n"
          + "	(\n"
          + "		select patient_id, referencia, max(date_created), data_inicio_programa\n"
          + "		from(\n"
          + "			select p.patient_id, pr.name referencia, max(pp.date_enrolled) as data_inicio_programa, pp.date_created\n"
          + "			from patient p\n"
          + "			inner join patient_program pp on pp.patient_id=p.patient_id\n"
          + "			inner join program pr on pr.program_id=pp.program_id\n"
          + "			where pp.date_enrolled < :endDate\n"
          + "			and pp.date_completed is null\n"
          + "			and pp.location_id=:location\n"
          + "			and p.voided=0 and pp.voided=0\n"
          + "			group by patient_id,pr.name\n"
          + "		) a group by patient_id\n"
          + "	) proveniencia on proveniencia.patient_id=inicio.patient_id\n"
          + "	left join\n"
          + "	(\n"
          + "		Select ultima_carga.patient_id, data_ultima_cv, value_numeric as ultima_cv, \"SIM\" as elegivel_cv\n"
          + "		from\n"
          + "		(	Select 	p.patient_id,max(o.obs_datetime) data_ultima_cv\n"
          + "			from 	patient p\n"
          + "			inner join encounter e on p.patient_id=e.patient_id\n"
          + "			inner join obs o on e.encounter_id=o.encounter_id\n"
          + "			where 	p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "			and e.encounter_type in (13,6,9) and \n"
          + "			o.concept_id=856 and o.value_numeric is not null and \n"
          + "			e.encounter_datetime < :endDate \n"
          + "			and e.location_id=:location\n"
          + "			group by p.patient_id\n"
          + "		) ultima_carga\n"
          + "		inner join obs on obs.person_id=ultima_carga.patient_id and obs.obs_datetime=ultima_carga.data_ultima_cv\n"
          + "		where 	obs.voided=0 and obs.concept_id=856 and obs.location_id=:location\n"
          + "	) elegiveis_cv on elegiveis_cv.patient_id=inicio.patient_id \n"
          + "		and (elegiveis_cv.data_ultima_cv < date_add(:endDate, interval -12 MONTH)\n"
          + "			or elegiveis_cv.data_ultima_cv >= date_add(:endDate, interval -12 MONTH) and elegiveis_cv.ultima_cv > 1000)\n"
          + "		and (inicio.data_inicio <= date_add(:endDate, interval -6 MONTH)\n"
          + "			or (inicio.data_inicio <= date_add(:endDate, interval -3 MONTH)\n"
          + "				and inicio.patient_id in\n"
          + "				(\n"
          + "					Select p.patient_id\n"
          + "					from patient p \n"
          + "					inner join encounter e on p.patient_id=e.patient_id\n"
          + "					inner join obs o on e.encounter_id=o.encounter_id\n"
          + "					where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "					and concept_id=1982 \n"
          + "					and value_coded=44 \n"
          + "					and e.encounter_type in (5,6) \n"
          + "					and e.encounter_datetime between :startDate and :endDate \n"
          + "					and e.location_id=:location\n"
          + "					\n"
          + "					union		\n"
          + "					\n"
          + "					Select p.patient_id\n"
          + "					from patient p inner join encounter e on p.patient_id=e.patient_id\n"
          + "					inner join obs o on e.encounter_id=o.encounter_id\n"
          + "					where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "					and concept_id=1279 \n"
          + "					and e.encounter_type in (5,6) \n"
          + "					and e.encounter_datetime  between :startDate and :endDate\n"
          + "					and e.location_id=:location\n"
          + "						\n"
          + "					union		\n"
          + "					\n"
          + "					Select p.patient_id\n"
          + "					from patient p inner join encounter e on p.patient_id=e.patient_id\n"
          + "					inner join obs o on e.encounter_id=o.encounter_id\n"
          + "					where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "					and concept_id=1600 \n"
          + "					and e.encounter_type in (5,6) \n"
          + "					and e.encounter_datetime  between :startDate and :endDate\n"
          + "					and e.location_id=:location		\n"
          + "					\n"
          + "					union\n"
          + "					\n"
          + "					select pp.patient_id\n"
          + "					from patient_program pp \n"
          + "					where pp.program_id=8 \n"
          + "					and pp.voided=0 \n"
          + "					and pp.date_enrolled between :startDate and :endDate\n"
          + "					and pp.location_id=:location\n"
          + "\n"
          + "					union\n"
          + "\n"
          + "					Select p.patient_id\n"
          + "					from patient p \n"
          + "					inner join encounter e on p.patient_id=e.patient_id\n"
          + "					inner join obs o on e.encounter_id=o.encounter_id\n"
          + "					where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "					and concept_id=5272\n"
          + "					and value_coded=1065 \n"
          + "					and e.encounter_type = 53 \n"
          + "					and o.obs_datetime between :startDate and :endDate\n"
          + "					and e.location_id=:location\n"
          + "				)\n"
          + "			))\n"
          + "	where inicio.patient_id not in\n"
          + "	(\n"
          + "		-- Pacientes que sairam do programa de tratamento\n"
          + "		select p.patient_id\n"
          + "		from patient p \n"
          + "		inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "		inner join patient_state ps on pg.patient_program_id=ps.patient_program_id\n"
          + "		where pg.program_id=2 -- SERVICO TARV - TRATAMENTO\n"
          + "		and ps.state in (7,8,9,10) -- TRANSFERIDO PARA, SUSPENDER TRATAMENTO, ABANDONO, OBITOU\n"
          + "		and ps.end_date is null\n"
          + "		and pg.voided=0 and ps.voided=0 and p.voided=0 \n"
          + "		and ps.start_date<= :endDate\n"
          + "		and location_id=:location\n"
          + "	\n"
          + "		union all\n"
          + "		\n"
          + "		-- Abandono não notificado\n"
          + "		select ultimo_fila.patient_id\n"
          + "		from\n"
          + "		(	select p.patient_id,max(encounter_datetime) encounter_datetime\n"
          + "			from patient p \n"
          + "			inner join encounter e on e.patient_id=p.patient_id\n"
          + "			where p.voided=0 and e.voided=0\n"
          + "			and e.encounter_type=18 \n"
          + "			and e.location_id=:location \n"
          + "			and e.encounter_datetime<=:endDate\n"
          + "			group by p.patient_id\n"
          + "		) ultimo_fila\n"
          + "		inner join obs o on o.person_id=ultimo_fila.patient_id\n"
          + "		where o.voided=0 \n"
          + "		and ultimo_fila.encounter_datetime=o.obs_datetime \n"
          + "		and o.concept_id=5096 -- \n"
          + "		and o.location_id=:location\n"
          + "		and ultimo_fila.patient_id not in 	\n"
          + "		(	select p.patient_id\n"
          + "			from patient p \n"
          + "			inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "			inner join patient_state ps on pg.patient_program_id=ps.patient_program_id\n"
          + "			where pg.voided=0 and ps.voided=0 and p.voided=0 \n"
          + "			and pg.program_id=2 \n"
          + "			and ps.state in (7,8,9,10) \n"
          + "			and ps.end_date is null\n"
          + "			and ps.start_date<= :endDate\n"
          + "			and location_id=:location\n"
          + "		)\n"
          + "		and ultimo_fila.patient_id not in\n"
          + "		(	select patient_id\n"
          + "			from\n"
          + "			(	select p.patient_id,max(encounter_datetime) encounter_datetime\n"
          + "				from patient p \n"
          + "				inner join encounter e on e.patient_id=p.patient_id\n"
          + "				where p.voided=0 and e.voided=0 \n"
          + "				and e.encounter_type in (6,9) \n"
          + "				and e.location_id=:location \n"
          + "				and e.encounter_datetime<= :endDate\n"
          + "				group by p.patient_id\n"
          + "			) ultimo_seguimento\n"
          + "			inner join obs o on o.person_id=ultimo_seguimento.patient_id\n"
          + "			where ultimo_seguimento.encounter_datetime=o.obs_datetime \n"
          + "			and o.voided=0 \n"
          + "			and o.concept_id=1410 -- DATA DE PROXIMA CONSULTA\n"
          + "			and o.location_id=:location \n"
          + "			and datediff(:endDate,o.value_datetime)<60\n"
          + "				\n"
          + "		)\n"
          + "		and ultimo_fila.patient_id not in\n"
          + "		(	select abandono.patient_id\n"
          + "			from \n"
          + "			(	select p.patient_id, ps.start_date\n"
          + "				from patient p \n"
          + "				inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "				inner join patient_state ps on pg.patient_program_id=ps.patient_program_id\n"
          + "				where pg.voided=0 and ps.voided=0 and p.voided=0 \n"
          + "				and pg.program_id=2 \n"
          + "				and ps.state=9 and ps.end_date is null \n"
          + "				and ps.start_date<=:endDate \n"
          + "				and location_id=:location\n"
          + "			)abandono\n"
          + "			inner join 	\n"
          + "			(	select max_fila.patient_id,max_fila.encounter_datetime,o.value_datetime\n"
          + "				from\n"
          + "				(	Select p.patient_id,max(encounter_datetime) encounter_datetime\n"
          + "					from patient p \n"
          + "					inner join encounter e on e.patient_id=p.patient_id\n"
          + "					where p.voided=0 and e.voided=0 and e.encounter_type=18 \n"
          + "					and e.location_id=:location \n"
          + "					and e.encounter_datetime<=:endDate\n"
          + "					group by p.patient_id\n"
          + "				) max_fila \n"
          + "				inner join obs o on o.person_id=max_fila.patient_id\n"
          + "				where max_fila.encounter_datetime=o.obs_datetime \n"
          + "				and o.voided=0 \n"
          + "				and o.concept_id=5096 \n"
          + "				and o.location_id=:location\n"
          + "			) ultimo_fila1 on abandono.patient_id=ultimo_fila1.patient_id\n"
          + "			where datediff(:endDate,ultimo_fila1.value_datetime)<60\n"
          + "		)\n"
          + "		and datediff(:endDate,o.value_datetime)>=60\n"
          + "	)\n"
          + "	group by pid.identifier\n"
          + ") elegiveis\n"
          + "where elegivel_cv='SIM'";

  public static final String PACIENTES_QUE_VISITARAM_US =
      "select pid.identifier as nid,\n"
          + "concat(ifnull(pn.given_name,''),' ',ifnull(pn.middle_name,''),' ',ifnull(pn.family_name,'')) as nome_completo,\n"
          + "pr.gender as genero,\n"
          + "round(datediff(current_date,pr.birthdate)/365) idade_actual,\n"
          + "seguimento.ultimo_seguimento,\n"
          + "ultimo.ultimo_levantamento,\n"
          + "proveniencia.referencia as proveniencia,\n"
          + "if(levantamento.patient_id is not null,'SIM','') as levantamento_arv,\n"
          + "if(ficha_resumo.patient_id is not null,'SIM','') as ficha_resumo,\n"
          + "if(ficha_clinica.patient_id is not null,'SIM','') as ficha_clinica,\n"
          + "if(ficha_apss.patient_id is not null,'SIM','') as ficha_apss\n"
          + "from(\n"
          + "	select e.patient_id, min(e.encounter_datetime) as data_visita \n"
          + "	from patient p\n"
          + "	inner join encounter e on p.patient_id=e.patient_id\n"
          + "	where p.voided=0 and e.voided=0 \n"
          + "	and e.encounter_datetime between :startDate and :endDate \n"
          + "	and e.location_id=:location\n"
          + "	group by p.patient_id\n"
          + ") visita\n"
          + "left join\n"
          + "(\n"
          + "	select e.patient_id, min(e.encounter_datetime) as data_visita\n"
          + "	from patient p\n"
          + "	inner join encounter e on p.patient_id=e.patient_id\n"
          + "	where p.voided=0 and e.voided=0 \n"
          + "	and e.encounter_type = 52 \n"
          + "	and e.encounter_datetime between :startDate and :endDate \n"
          + "	and e.location_id=:location\n"
          + "	group by p.patient_id\n"
          + ") levantamento on visita.patient_id=levantamento.patient_id\n"
          + "left join\n"
          + "(\n"
          + "	select e.patient_id, min(e.encounter_datetime) as data_visita\n"
          + "	from patient p\n"
          + "	inner join encounter e on p.patient_id=e.patient_id\n"
          + "	where p.voided=0 and e.voided=0 \n"
          + "	and e.encounter_type = 53 \n"
          + "	and e.encounter_datetime between :startDate and :endDate \n"
          + "	and e.location_id=:location\n"
          + "	group by p.patient_id\n"
          + ") ficha_resumo on visita.patient_id=ficha_resumo.patient_id\n"
          + "left join\n"
          + "(\n"
          + "	select e.patient_id, min(e.encounter_datetime) as data_visita\n"
          + "	from patient p\n"
          + "	inner join encounter e on p.patient_id=e.patient_id\n"
          + "	inner join form f on e.form_id=f.form_id\n"
          + "	where p.voided=0 and e.voided=0 \n"
          + "	and e.encounter_type in (6,9) \n"
          + "	and f.form_id=163\n"
          + "	and e.encounter_datetime between :startDate and :endDate \n"
          + "	and e.location_id=:location\n"
          + "	group by p.patient_id\n"
          + ") ficha_clinica on visita.patient_id=ficha_clinica.patient_id\n"
          + "left join\n"
          + "(\n"
          + "	select e.patient_id, min(e.encounter_datetime) as data_visita\n"
          + "	from patient p\n"
          + "	inner join encounter e on p.patient_id=e.patient_id\n"
          + "	inner join form f on e.form_id=f.form_id\n"
          + "	where p.voided=0 and e.voided=0 \n"
          + "	and e.encounter_type in (34,35) \n"
          + "	and f.form_id=164\n"
          + "	and e.encounter_datetime between :startDate and :endDate \n"
          + "	and e.location_id=:location\n"
          + "	group by p.patient_id\n"
          + ") ficha_apss on visita.patient_id=ficha_apss.patient_id\n"
          + "left join\n"
          + "(	select max_frida.patient_id,max_frida.ultimo_levantamento,o.value_datetime\n"
          + "	from\n"
          + "	(	Select p.patient_id,max(encounter_datetime) ultimo_levantamento\n"
          + "		from patient p \n"
          + "		inner join encounter e on e.patient_id=p.patient_id\n"
          + "		where p.voided=0 and e.voided=0 \n"
          + "		and e.encounter_type in (18,52) \n"
          + "		and e.location_id=:location \n"
          + "		and e.encounter_datetime between :startDate and :endDate\n"
          + "		group by p.patient_id\n"
          + "	) max_frida \n"
          + "	left join obs o on o.person_id=max_frida.patient_id and max_frida.ultimo_levantamento=o.obs_datetime and o.voided=0 and o.concept_id=5096\n"
          + ") ultimo on visita.patient_id=ultimo.patient_id\n"
          + "left join\n"
          + "(	select max_seguimento.patient_id,max_seguimento.ultimo_seguimento,o.value_datetime\n"
          + "	from\n"
          + "	(	Select p.patient_id,max(encounter_datetime) ultimo_seguimento\n"
          + "		from patient p \n"
          + "		inner join encounter e on e.patient_id=p.patient_id\n"
          + "		where p.voided=0 and e.voided=0 \n"
          + "		and e.encounter_type in (6,9) \n"
          + "		and e.location_id=:location \n"
          + "		and e.encounter_datetime between :startDate and :endDate\n"
          + "		group by p.patient_id\n"
          + "	) max_seguimento \n"
          + "	left join obs o on o.person_id=max_seguimento.patient_id and max_seguimento.ultimo_seguimento=o.obs_datetime and o.voided=0 and o.concept_id=1410		\n"
          + ") seguimento on visita.patient_id=seguimento.patient_id\n"
          + "left join\n"
          + "(\n"
          + "	select patient_id, referencia, max(date_created), data_inicio_programa\n"
          + "	from(\n"
          + "		select p.patient_id, pr.name referencia, max(pp.date_enrolled) as data_inicio_programa, pp.date_created\n"
          + "		from patient p\n"
          + "		inner join patient_program pp on pp.patient_id=p.patient_id\n"
          + "		inner join program pr on pr.program_id=pp.program_id\n"
          + "		where pp.date_enrolled < :endDate\n"
          + "		and pp.date_completed is null\n"
          + "		and pp.location_id=:location\n"
          + "		and p.voided=0 and pp.voided=0\n"
          + "		group by patient_id,pr.name\n"
          + "	) a group by patient_id\n"
          + ") proveniencia on proveniencia.patient_id=visita.patient_id\n"
          + "left join 			\n"
          + "(	select pn1.*\n"
          + "	from person_name pn1\n"
          + "	inner join \n"
          + "	(\n"
          + "		select person_id,min(person_name_id) id \n"
          + "		from person_name\n"
          + "		where voided=0\n"
          + "		group by person_id\n"
          + "	) pn2\n"
          + "	where pn1.person_id=pn2.person_id and pn1.person_name_id=pn2.id\n"
          + ") pn on pn.person_id=visita.patient_id	\n"
          + "left join\n"
          + "(   select pid1.*\n"
          + "	from patient_identifier pid1\n"
          + "	inner join\n"
          + "	(\n"
          + "		select patient_id,min(patient_identifier_id) id\n"
          + "		from patient_identifier\n"
          + "		where voided=0\n"
          + "		group by patient_id\n"
          + "	) pid2\n"
          + "	where pid1.patient_id=pid2.patient_id and pid1.patient_identifier_id=pid2.id\n"
          + ") pid on pid.patient_id=visita.patient_id	\n"
          + "left join person pr on pr.person_id=visita.patient_id";

  /** São pacientes com marcação para consulta de seguimento ou levantamento num período */
  public static final String MARCADOS_SEGUIMENTO_LEVANTAMENTO =
      "Select 	marcados.patient_id,\n"
          + "pe.county_district as 'Distrito',\n"
          + "pe.address2 as 'PAdministrativo',\n"
          + "pe.address6 as localidade,\n"
          + "pe.address5 as bairro,\n"
          + "pe.address1 as ponto_referencia,\n"
          + "pat.value as telefone,\n"
          + "confidente.telefone as telefone_confidente,\n"
          + "inscricao.telefone as telefone_referencia,\n"
          + "proveniencia.referencia as proveniencia,\n"
          + "concat(ifnull(pn.given_name,''),' ',ifnull(pn.middle_name,''),' ',ifnull(pn.family_name,'')) as nome_completo,\n"
          + "pid.identifier as nid,\n"
          + "p.gender as genero,\n"
          + "round(datediff(curdate(),p.birthdate)/365) idade,\n"
          + "levantamento.ultimo_levantamento as ultimo_lev,\n"
          + "levantamento.proximo_levantamento as proximo_lev,\n"
          + "seguimento.ultimo_seguimento as ultimo_seg,\n"
          + "seguimento.proximo_seguimento as proximo_seg,\n"
          + "inicio.data_inicio,\n"
          + "inicio_tpi.data_inicio_tpi as inicio_tpi,\n"
          + "fim_tpi.data_fim_tpi as termino_tpi,\n"
          + "ultima_cv.data_carga as data_ultima_cv, \n"
          + "ultima_cv.cv as ultima_cv, \n"
          + "penultima_cv.data_carga as data_penultima_cv, \n"
          + "penultima_cv.cv as penultima_cv\n"
          + "from	\n"
          + "(	select patient_id\n"
          + "	from(\n"
          + "		select p.patient_id, max(o.value_datetime) as proxima_visita\n"
          + "		from patient p\n"
          + "		inner join encounter e on p.patient_id=e.patient_id \n"
          + "		inner join obs o on e.encounter_id=o.encounter_id\n"
          + "		where o.concept_id in (1410,5096)\n"
          + "		and p.voided=0 and e.voided=0 and o.voided=0\n"
          + "		and e.encounter_type in (6,9,18) \n"
          + "		and e.location_id=:location\n"
          + "		group by o.person_id\n"
          + "	) proxima\n"
          + "	where proxima_visita between :startDate and :endDate\n"
          + ") marcados\n"
          + "left join\n"
          + "(	select max_fila.patient_id,max_fila.ultimo_levantamento,o.value_datetime as proximo_levantamento\n"
          + "	from\n"
          + "	(	Select p.patient_id,max(encounter_datetime) ultimo_levantamento\n"
          + "		from patient p \n"
          + "		inner join encounter e on e.patient_id=p.patient_id\n"
          + "		where p.voided=0 and e.voided=0 \n"
          + "		and e.encounter_type = 18 \n"
          + "		and e.location_id=:location \n"
          + "		group by p.patient_id\n"
          + "	) max_fila \n"
          + "	left join obs o on o.person_id=max_fila.patient_id and max_fila.ultimo_levantamento=o.obs_datetime and o.voided=0 and o.concept_id=5096\n"
          + ") levantamento on marcados.patient_id=levantamento.patient_id\n"
          + "left join\n"
          + "(	select max_seguimento.patient_id,max_seguimento.ultimo_seguimento,o.value_datetime as proximo_seguimento\n"
          + "	from\n"
          + "	(	Select p.patient_id,max(encounter_datetime) ultimo_seguimento\n"
          + "		from patient p \n"
          + "		inner join encounter e on e.patient_id=p.patient_id\n"
          + "		where p.voided=0 and e.voided=0 \n"
          + "		and e.encounter_type in (6,9) \n"
          + "		and e.location_id=:location \n"
          + "		group by p.patient_id\n"
          + "	) max_seguimento \n"
          + "	left join obs o on o.person_id=max_seguimento.patient_id and max_seguimento.ultimo_seguimento=o.obs_datetime and o.voided=0 and o.concept_id=1410\n"
          + ") seguimento on marcados.patient_id=seguimento.patient_id\n"
          + "left join\n"
          + "(\n"
          + "	Select patient_id,min(data_inicio) data_inicio\n"
          + "	from\n"
          + "	(	Select 	p.patient_id,min(e.encounter_datetime) data_inicio\n"
          + "		from patient p \n"
          + "		inner join encounter e on p.patient_id=e.patient_id	\n"
          + "		inner join obs o on o.encounter_id=e.encounter_id\n"
          + "		where e.voided=0 and o.voided=0 and p.voided=0 \n"
          + "		and e.encounter_type in (18,6,9) \n"
          + "		and o.concept_id=1255 \n"
          + "		and o.value_coded=1256 \n"
          + "		and e.encounter_datetime<=:endDate \n"
          + "		and e.location_id=:location\n"
          + "		group by p.patient_id\n"
          + "\n"
          + "		union\n"
          + "\n"
          + "		Select p.patient_id,min(value_datetime) data_inicio\n"
          + "		from patient p\n"
          + "		inner join encounter e on p.patient_id=e.patient_id\n"
          + "		inner join obs o on e.encounter_id=o.encounter_id\n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "		and e.encounter_type in (18,6,9,53) \n"
          + "		and o.concept_id=1190 \n"
          + "		and o.value_datetime is not null \n"
          + "		and o.value_datetime<=:endDate \n"
          + "		and e.location_id=:location\n"
          + "		group by p.patient_id\n"
          + "\n"
          + "		union\n"
          + "\n"
          + "		select pg.patient_id,date_enrolled data_inicio\n"
          + "		from patient p inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "		where pg.voided=0 and p.voided=0 \n"
          + "		and program_id=2 \n"
          + "		and date_enrolled<=:endDate \n"
          + "		and location_id=:location\n"
          + "		\n"
          + "		union\n"
          + "		\n"
          + "		\n"
          + "		SELECT e.patient_id, MIN(e.encounter_datetime) AS data_inicio \n"
          + "		FROM patient p\n"
          + "		inner join encounter e on p.patient_id=e.patient_id\n"
          + "		WHERE p.voided=0 AND e.voided=0 \n"
          + "		and e.encounter_type in (18,52) \n"
          + "		and e.encounter_datetime<=:endDate \n"
          + "		and e.location_id=:location\n"
          + "		GROUP BY 	p.patient_id\n"
          + "	) inicio0\n"
          + "	group by patient_id\n"
          + ") inicio on marcados.patient_id=inicio.patient_id\n"
          + "inner join\n"
          + "(\n"
          + "	select p.patient_id,o1.value_text as telefone\n"
          + "	from patient p \n"
          + "	inner join encounter e on e.patient_id=p.patient_id\n"
          + "	left join obs o1 on o1.encounter_id=e.encounter_id and o1.concept_id=1611\n"
          + "	where e.voided=0 and p.voided=0 \n"
          + "	and e.encounter_type in (5,7) \n"
          + "	and e.encounter_datetime<=:endDate \n"
          + "	and e.location_id = :location\n"
          + "\n"
          + "	union\n"
          + "\n"
          + "	select pg.patient_id, null as telefone\n"
          + "	from patient p inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "	where pg.voided=0 and p.voided=0 \n"
          + "	and program_id=1 \n"
          + "	and date_enrolled<=:endDate \n"
          + "	and location_id=:location\n"
          + "	\n"
          + "	union\n"
          + "\n"
          + "	Select 	e.patient_id, o2.value_text as telefone\n"
          + "	from encounter e\n"
          + "	left join obs o2 on o2.encounter_id=e.encounter_id and o2.concept_id=6224\n"
          + "	where e.encounter_type = 53 \n"
          + "	and e.voided=0\n"
          + "	and e.encounter_datetime < :endDate \n"
          + "	and e.location_id=:location\n"
          + ")inscricao on inicio.patient_id=inscricao.patient_id\n"
          + "left join\n"
          + "(\n"
          + "	-- PACIENTES QUE INICIARAM TPI\n"
          + "	select p.patient_id, max(o.value_datetime) as data_inicio_tpi\n"
          + "	from	patient p\n"
          + "	inner join encounter e on p.patient_id=e.patient_id\n"
          + "	inner join obs o on o.encounter_id=e.encounter_id\n"
          + "	where e.voided=0 and p.voided=0 and o.voided=0 \n"
          + "	and o.concept_id=6128 -- DATA DE INICIO DA PROFILAXIA COM ISONIAZIDA\n"
          + "	and e.encounter_type in (6,9,53) -- S.TARV: ADULTO SEGUIMENTO, S.TARV: PEDIATRIA SEGUIMENTO\n"
          + "	and e.location_id=:location\n"
          + "	group by p.patient_id\n"
          + "\n"
          + "	union\n"
          + "\n"
          + "	select e.patient_id, max(e.encounter_datetime) data_inicio_tpi\n"
          + "	from patient p\n"
          + "	inner join encounter e on e.patient_id=p.patient_id\n"
          + "	inner join obs o on o.encounter_id=e.encounter_id\n"
          + "	where e.voided=0 and p.voided=0 and o.voided=0 \n"
          + "	and e.voided=0 and p.voided=0 and o.voided=0 \n"
          + "	and e.location_id=:location \n"
          + "	and e.encounter_type in (6,9) \n"
          + "	and o.concept_id=6122 \n"
          + "	and o.value_coded=1256\n"
          + "	group by e.patient_id\n"
          + ") inicio_tpi on inicio.patient_id=inicio_tpi.patient_id\n"
          + "left join\n"
          + "(\n"
          + "	-- PACIENTES QUE TERMINARAM TPI\n"
          + "	select p.patient_id, o.value_datetime as data_fim_tpi\n"
          + "	from	patient p\n"
          + "	inner join encounter e on p.patient_id=e.patient_id\n"
          + "	inner join obs o on o.encounter_id=e.encounter_id\n"
          + "	where e.voided=0 and p.voided=0 and o.voided=0\n"
          + "	and o.concept_id=6129 -- DATA DE FIM DA PROFILAXIA COM ISONIAZIDA\n"
          + "	and e.encounter_type in (6,9,53) -- S.TARV: ADULTO SEGUIMENTO, S.TARV: PEDIATRIA SEGUIMENTO \n"
          + "	and e.location_id=:location\n"
          + "\n"
          + "	union\n"
          + "\n"
          + "	select e.patient_id, max(e.encounter_datetime) data_fim_tpi\n"
          + "	from patient p\n"
          + "	inner join encounter e on e.patient_id=p.patient_id\n"
          + "	inner join obs o on o.encounter_id=e.encounter_id\n"
          + "	where e.voided=0 and p.voided=0 and o.voided=0 \n"
          + "	and e.location_id=:location \n"
          + "	and e.encounter_type in (6,9) \n"
          + "	and o.concept_id=6122 \n"
          + "	and o.value_coded=1267\n"
          + "	group by e.patient_id\n"
          + ") fim_tpi on inicio_tpi.patient_id=fim_tpi.patient_id and inicio_tpi.data_inicio_tpi<fim_tpi.data_fim_tpi\n"
          + "left join\n"
          + "(\n"
          + "	Select ultima_carga.patient_id, data_carga, obs.value_numeric cv\n"
          + "	from\n"
          + "	(	Select p.patient_id,max(o.obs_datetime) data_carga\n"
          + "		from patient p\n"
          + "		inner join encounter e on p.patient_id=e.patient_id\n"
          + "		inner join obs o on e.encounter_id=o.encounter_id\n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "		and e.encounter_type in (13,6,9,53) \n"
          + "		and o.concept_id = 856 \n"
          + "		and o.value_numeric is not null \n"
          + "		and o.obs_datetime <= :endDate \n"
          + "		and e.location_id=:location\n"
          + "		group by p.patient_id\n"
          + "	) ultima_carga\n"
          + "	inner join obs on obs.person_id=ultima_carga.patient_id and obs.obs_datetime=ultima_carga.data_carga\n"
          + "	where obs.voided=0 \n"
          + "	and obs.concept_id = 856 \n"
          + "	and obs.location_id=:location \n"
          + "	-- and obs.obs_datetime > date_add(:endDate, interval -1 year)\n"
          + "	group by patient_id\n"
          + ") ultima_cv on ultima_cv.patient_id=marcados.patient_id\n"
          + "left join\n"
          + "(\n"
          + "	Select ultima_carga.patient_id, data_carga, obs.value_numeric cv\n"
          + "	from\n"
          + "	(	Select p.patient_id,max(o.obs_datetime) data_carga\n"
          + "		from patient p\n"
          + "		inner join encounter e on p.patient_id=e.patient_id\n"
          + "		inner join obs o on e.encounter_id=o.encounter_id\n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "		and e.encounter_type in (13,6,9,53) \n"
          + "		and o.concept_id = 856 \n"
          + "		and o.value_numeric is not null \n"
          + "		and o.obs_datetime < (select max(o1.obs_datetime) from obs o1 where o1.voided=0 and o1.concept_id=856 and o1.person_id=p.patient_id) \n"
          + "		and e.location_id=:location\n"
          + "		group by p.patient_id\n"
          + "	) ultima_carga\n"
          + "	inner join obs on obs.person_id=ultima_carga.patient_id and obs.obs_datetime=ultima_carga.data_carga\n"
          + "	where obs.voided=0 \n"
          + "	and obs.concept_id = 856 \n"
          + "	and obs.location_id=:location \n"
          + "	group by patient_id\n"
          + ") penultima_cv on penultima_cv.patient_id=marcados.patient_id\n"
          + "inner join person p on p.person_id=marcados.patient_id\n"
          + "left join person_address pe on pe.person_id=marcados.patient_id and pe.preferred=1\n"
          + "left join person_name pn on pn.person_id=marcados.patient_id and pn.preferred=1\n"
          + "left join patient_identifier pid on pid.patient_id=marcados.patient_id and pid.preferred=1 and pid.identifier_type=2\n"
          + "left join person_attribute pat on pat.person_id=pe.person_id and pat.person_attribute_type_id=9		\n"
          + "left join\n"
          + "(\n"
          + "	select patient_id, referencia, max(date_created), data_inicio_programa\n"
          + "	from(\n"
          + "		select p.patient_id, pr.name referencia, max(pp.date_enrolled) as data_inicio_programa, pp.date_created\n"
          + "		from patient p\n"
          + "		inner join patient_program pp on pp.patient_id=p.patient_id\n"
          + "		inner join program pr on pr.program_id=pp.program_id\n"
          + "		where pp.date_enrolled < :endDate\n"
          + "		and pp.date_completed is null\n"
          + "		and pp.location_id=:location\n"
          + "		and p.voided=0 and pp.voided=0\n"
          + "		group by patient_id,pr.name\n"
          + "	) a group by patient_id\n"
          + ")proveniencia on proveniencia.patient_id=marcados.patient_id\n"
          + "left join\n"
          + "(\n"
          + "	select p.patient_id, o.value_text as telefone\n"
          + "	from patient p\n"
          + "	inner join encounter e on e.patient_id=p.patient_id\n"
          + "	inner join obs o on o.encounter_id=e.encounter_id \n"
          + "	where p.voided=0 and e.voided=0 and o.voided=0\n"
          + "	and e.encounter_type=34\n"
          + "	and o.concept_id=1611\n"
          + "	and e.location_id=:location\n"
          + "\n"
          + "	union\n"
          + "	\n"
          + "	select p.patient_id, o.value_text as telefone\n"
          + "	from patient p\n"
          + "	inner join encounter e on e.patient_id=p.patient_id\n"
          + "	inner join obs o on o.encounter_id=e.encounter_id \n"
          + "	where p.voided=0 and e.voided=0 and o.voided=0\n"
          + "	and e.encounter_type=53\n"
          + "	and o.concept_id=6224\n"
          + "	and e.location_id=:location\n"
          + ") confidente on marcados.patient_id=confidente.patient_id\n"
          + "group by patient_id";

  public static final String REINICIOS_TARV =
      "select * \n"
          + "from \n"
          + "(	select 	inicio.patient_id,\n"
          + "	inicio.data_inicio,\n"
          + "	ultimo.ultimo_levantamento ultimo_lev,\n"
          + "	ultimo.value_datetime proximo_lev,\n"
          + "	reinicio.data_reinicio,\n"
          + "	pid.identifier nid,\n"
          + "	pad3.address6 localidade,\n"
          + "	pad3.address5 bairro,\n"
          + "	pad3.address3 celula,\n"
          + "	pad3.address1 ponto_referencia,\n"
          + "	pat.value as telefone,\n"
          + "	confidente.telefone as telefone_confidente,\n"
          + "	inscricao.telefone as telefone_referencia,\n"
          + "	concat(ifnull(pn.given_name,''),' ',ifnull(pn.middle_name,''),' ',ifnull(pn.family_name,'')) as nome_completo,\n"
          + "	pr.gender as genero,\n"
          + "	round(datediff(:endDate,pr.birthdate)/365) idade_actual,\n"
          + "	if(gravida.patient_id is not null,'SIM','') gravida,\n"
          + "	populacao_chave.key_pop\n"
          + "	from		\n"
          + "	(	Select patient_id,min(data_inicio) data_inicio\n"
          + "		from\n"
          + "		(	Select 	p.patient_id,min(e.encounter_datetime) data_inicio\n"
          + "			from patient p \n"
          + "			inner join encounter e on p.patient_id=e.patient_id	\n"
          + "			inner join obs o on o.encounter_id=e.encounter_id\n"
          + "			where e.voided=0 and o.voided=0 and p.voided=0 \n"
          + "			and e.encounter_type in (18,6,9) \n"
          + "			and o.concept_id=1255 \n"
          + "			and o.value_coded=1256 \n"
          + "			and e.encounter_datetime<=:endDate \n"
          + "			and e.location_id=:location\n"
          + "			group by p.patient_id\n"
          + "	\n"
          + "			union\n"
          + "	\n"
          + "			Select p.patient_id,min(value_datetime) data_inicio\n"
          + "			from patient p\n"
          + "			inner join encounter e on p.patient_id=e.patient_id\n"
          + "			inner join obs o on e.encounter_id=o.encounter_id\n"
          + "			where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "			and e.encounter_type in (18,6,9,53) \n"
          + "			and o.concept_id=1190 \n"
          + "			and o.value_datetime is not null \n"
          + "			and o.value_datetime<=:endDate \n"
          + "			and e.location_id=:location\n"
          + "			group by p.patient_id\n"
          + "\n"
          + "			union\n"
          + "\n"
          + "			select pg.patient_id,date_enrolled data_inicio\n"
          + "			from patient p inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "			where pg.voided=0 and p.voided=0 \n"
          + "			and program_id=2 \n"
          + "			and date_enrolled<=:endDate \n"
          + "			and location_id=:location\n"
          + "			\n"
          + "			union\n"
          + "			\n"
          + "			\n"
          + "			SELECT e.patient_id, MIN(e.encounter_datetime) AS data_inicio \n"
          + "			FROM patient p\n"
          + "			inner join encounter e on p.patient_id=e.patient_id\n"
          + "			WHERE p.voided=0 AND e.voided=0 \n"
          + "			and e.encounter_type in (18,52) \n"
          + "			and e.encounter_datetime<=:endDate \n"
          + "			and e.location_id=:location\n"
          + "			GROUP BY p.patient_id\n"
          + "		) inicio0\n"
          + "		group by patient_id	\n"
          + "	)inicio\n"
          + "	inner join\n"
          + "	(\n"
          + "		select p.patient_id,o1.value_text as telefone\n"
          + "		from patient p \n"
          + "		inner join encounter e on e.patient_id=p.patient_id\n"
          + "		left join obs o1 on o1.encounter_id=e.encounter_id and o1.concept_id=1611\n"
          + "		where e.voided=0 and p.voided=0 \n"
          + "		and e.encounter_type in (5,7) \n"
          + "		and e.encounter_datetime<=:endDate \n"
          + "		and e.location_id = :location\n"
          + "\n"
          + "		union\n"
          + "\n"
          + "		select pg.patient_id, null as telefone\n"
          + "		from patient p inner join patient_program pg on p.patient_id=pg.patient_id\n"
          + "		where pg.voided=0 and p.voided=0 \n"
          + "		and program_id=1 \n"
          + "		and date_enrolled<=:endDate \n"
          + "		and location_id=:location\n"
          + "		\n"
          + "		union\n"
          + "\n"
          + "		Select 	e.patient_id, o2.value_text as telefone\n"
          + "		from encounter e\n"
          + "		left join obs o2 on o2.encounter_id=e.encounter_id and o2.concept_id=6224\n"
          + "		where e.encounter_type = 53 \n"
          + "		and e.voided=0\n"
          + "		and e.encounter_datetime < :endDate \n"
          + "		and e.location_id=:location\n"
          + "	)inscricao on inicio.patient_id=inscricao.patient_id\n"
          + "	inner join\n"
          + "	(\n"
          + "		select 	p.patient_id,max(e.encounter_datetime) data_reinicio\n"
          + "		from patient p \n"
          + "		inner join encounter e on p.patient_id=e.patient_id	\n"
          + "		inner join obs o on o.encounter_id=e.encounter_id\n"
          + "		where e.voided=0 and o.voided=0 and p.voided=0 \n"
          + "		and e.encounter_type in (18,6,9) \n"
          + "		and o.concept_id in (1255,6273) \n"
          + "		and o.value_coded=1705 \n"
          + "		and e.encounter_datetime between :startDate and :endDate \n"
          + "		and e.location_id=:location\n"
          + "		group by p.patient_id\n"
          + "	) reinicio on reinicio.patient_id=inicio.patient_id\n"
          + "	left join\n"
          + "	(	select max_frida.patient_id,max_frida.ultimo_levantamento,o.value_datetime\n"
          + "		from\n"
          + "		(	Select p.patient_id,max(encounter_datetime) ultimo_levantamento\n"
          + "			from patient p \n"
          + "			inner join encounter e on e.patient_id=p.patient_id\n"
          + "			where p.voided=0 and e.voided=0 \n"
          + "			and e.encounter_type=18 \n"
          + "			and e.location_id=:location \n"
          + "			and e.encounter_datetime<=:endDate\n"
          + "			group by p.patient_id\n"
          + "		) max_frida \n"
          + "		left join obs o on o.person_id=max_frida.patient_id and max_frida.ultimo_levantamento=o.obs_datetime and o.voided=0 and o.concept_id=5096		\n"
          + "	) ultimo on inicio.patient_id=ultimo.patient_id\n"
          + "	left join \n"
          + "	(\n"
          + "		Select p.patient_id,e.encounter_datetime\n"
          + "		from patient p \n"
          + "		inner join encounter e on p.patient_id=e.patient_id\n"
          + "		inner join obs o on e.encounter_id=o.encounter_id\n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "		and concept_id=1982 \n"
          + "		and value_coded=44 \n"
          + "		and e.encounter_type in (5,6) \n"
          + "		and e.encounter_datetime between :startDate and :endDate \n"
          + "		and e.location_id=:location\n"
          + "\n"
          + "		union		\n"
          + "				\n"
          + "		Select p.patient_id,e.encounter_datetime\n"
          + "		from patient p inner join encounter e on p.patient_id=e.patient_id\n"
          + "		inner join obs o on e.encounter_id=o.encounter_id\n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "		and concept_id=1279 \n"
          + "		and e.encounter_type in (5,6) \n"
          + "		and e.encounter_datetime between :startDate and :endDate \n"
          + "		and e.location_id=:location\n"
          + "\n"
          + "		union		\n"
          + "				\n"
          + "		Select p.patient_id,e.encounter_datetime\n"
          + "		from patient p inner join encounter e on p.patient_id=e.patient_id\n"
          + "		inner join obs o on e.encounter_id=o.encounter_id\n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "		and concept_id=1600 \n"
          + "		and e.encounter_type in (5,6) \n"
          + "		and e.encounter_datetime between :startDate and :endDate \n"
          + "		and e.location_id=:location		\n"
          + "				\n"
          + "		union\n"
          + "				\n"
          + "		select pp.patient_id,pp.date_enrolled\n"
          + "		from patient_program pp \n"
          + "		where pp.program_id=8 and pp.voided=0 \n"
          + "		and pp.date_enrolled between :startDate and :endDate \n"
          + "		and pp.location_id=:location\n"
          + "\n"
          + "		union\n"
          + "\n"
          + "		select max_gravidez.patient_id,max_gravidez.ultimo_estado_gravidez\n"
          + "		from\n"
          + "		(	Select p.patient_id,max(obs_datetime) ultimo_estado_gravidez\n"
          + "			from patient p \n"
          + "			inner join encounter e on p.patient_id=e.patient_id\n"
          + "			inner join obs o on e.encounter_id=o.encounter_id\n"
          + "			where p.voided=0 and e.voided=0 and o.voided=0 \n"
          + "			and concept_id=5272\n"
          + "			and value_coded=1065 \n"
          + "			and e.encounter_type = 53 \n"
          + "			and o.obs_datetime <= :endDate \n"
          + "			and e.location_id=:location\n"
          + "			group by patient_id\n"
          + "		) max_gravidez \n"
          + "		left join obs o on o.person_id=max_gravidez.patient_id and max_gravidez.ultimo_estado_gravidez=o.obs_datetime and o.voided=0 and o.concept_id=5272\n"
          + "	) gravida on gravida.patient_id= inicio.patient_id\n"
          + "	left join\n"
          + "	(\n"
          + "		select e.patient_id,\n"
          + "		case o.value_coded\n"
          + "		when 1377 then 'HSH'\n"
          + "		when 20454 then 'PID'\n"
          + "		when 20426 then 'REC'\n"
          + "		when 1901 then 'MTS'\n"
          + "		when 5622 then 'Outro' end as key_pop\n"
          + "		from patient p\n"
          + "		inner join encounter e on e.patient_id=p.patient_id\n"
          + "		inner join obs o on o.encounter_id=e.encounter_id\n"
          + "		where e.encounter_datetime between :startDate and :endDate\n"
          + "		and e.voided=0 and p.voided=0 and o.voided=0 \n"
          + "		and e.location_id=:location \n"
          + "		and e.encounter_type in (6,9,35) \n"
          + "		and o.concept_id=23703 \n"
          + "		and o.value_coded is not null\n"
          + "	) populacao_chave on inicio.patient_id=populacao_chave.patient_id	\n"
          + "	left join \n"
          + "	(	select pad1.*\n"
          + "		from person_address pad1\n"
          + "		inner join \n"
          + "		(\n"
          + "			select person_id,min(person_address_id) id \n"
          + "			from person_address\n"
          + "			where voided=0\n"
          + "			group by person_id\n"
          + "		) pad2\n"
          + "		where pad1.person_id=pad2.person_id and pad1.person_address_id=pad2.id\n"
          + "	) pad3 on pad3.person_id=inicio.patient_id				\n"
          + "	left join 			\n"
          + "	(	select pn1.*\n"
          + "		from person_name pn1\n"
          + "		inner join \n"
          + "		(\n"
          + "			select person_id,min(person_name_id) id \n"
          + "			from person_name\n"
          + "			where voided=0\n"
          + "			group by person_id\n"
          + "		) pn2\n"
          + "		where pn1.person_id=pn2.person_id and pn1.person_name_id=pn2.id\n"
          + "	) pn on pn.person_id=inicio.patient_id			\n"
          + "	left join\n"
          + "	(   select pid1.*\n"
          + "		from patient_identifier pid1\n"
          + "		inner join\n"
          + "		(\n"
          + "			select patient_id,min(patient_identifier_id) id\n"
          + "			from patient_identifier\n"
          + "			where voided=0\n"
          + "			group by patient_id\n"
          + "		) pid2\n"
          + "		where pid1.patient_id=pid2.patient_id and pid1.patient_identifier_id=pid2.id\n"
          + "	) pid on pid.patient_id=inicio.patient_id	\n"
          + "	left join person pr on pr.person_id=inicio.patient_id\n"
          + "	left join person_attribute pat on pat.person_id=inicio.patient_id and pat.person_attribute_type_id=9 and pat.value is not null and pat.value<>'' and pat.voided=0\n"
          + "	left join\n"
          + "	(\n"
          + "		select p.patient_id, o.value_text as telefone\n"
          + "		from patient p\n"
          + "		inner join encounter e on e.patient_id=p.patient_id\n"
          + "		inner join obs o on o.encounter_id=e.encounter_id \n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0\n"
          + "		and e.encounter_type=34\n"
          + "		and o.concept_id=1611\n"
          + "		and e.location_id=:location\n"
          + "\n"
          + "		union\n"
          + "		\n"
          + "		select p.patient_id, o.value_text as telefone\n"
          + "		from patient p\n"
          + "		inner join encounter e on e.patient_id=p.patient_id\n"
          + "		inner join obs o on o.encounter_id=e.encounter_id \n"
          + "		where p.voided=0 and e.voided=0 and o.voided=0\n"
          + "		and e.encounter_type=53\n"
          + "		and o.concept_id=6224\n"
          + "		and e.location_id=:location\n"
          + "	) confidente on inicio.patient_id=confidente.patient_id\n"
          + ") coortes\n"
          + "group by patient_id";
}
